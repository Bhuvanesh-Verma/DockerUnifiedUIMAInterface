<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="/assets/css/style.css?v=" media="screen" type="text/css">
    <link rel="stylesheet" href="/assets/css/print.css" media="print" type="text/css">

    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <![endif]-->

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Docker Unified UIMA Interface (DUUI) | A framework at the dawn of a new era for NLP processing</title>
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="Docker Unified UIMA Interface (DUUI)" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A framework at the dawn of a new era for NLP processing" />
<meta property="og:description" content="A framework at the dawn of a new era for NLP processing" />
<link rel="canonical" href="http://localhost:4000/tutorial/FactChecking.html" />
<meta property="og:url" content="http://localhost:4000/tutorial/FactChecking.html" />
<meta property="og:site_name" content="Docker Unified UIMA Interface (DUUI)" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Docker Unified UIMA Interface (DUUI)" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"A framework at the dawn of a new era for NLP processing","headline":"Docker Unified UIMA Interface (DUUI)","url":"http://localhost:4000/tutorial/FactChecking.html"}</script>
<!-- End Jekyll SEO tag -->


    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" -->

<!-- end custom head snippets -->

  </head>

  <body>
    <header>
      <div class="inner">
        <a href="http://localhost:4000/">
          <h1>Docker Unified UIMA Interface (DUUI)</h1>
        </a>
        <h2>A framework at the dawn of a new era for NLP processing</h2>

      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
          <h1 id="integration-of-fact-checking-step-by-step">Integration of Fact-Checking Step by Step</h1>
<p>The Integration for this example is with python, because the fact-checking tool is implemented in python.
In this section, we will explain how to integrate a fact-checking tool into the DUUI pipeline step by step.
The fact-checking module is a part of the DUUI pipeline that is responsible for calculating how strong the claim is supported by the fact.
We use UniEval (<a href="https://aclanthology.org/2022.emnlp-main.131/">Zhong et al. 2022</a>) as the tool, which allows us to check whether a claim is supported by a fact.</p>

<h2 id="typeystem-for-fact-checking">Typeystem for Fact-Checking</h2>
<p>The first step is to define the typesystem for the fact-checking tool, if the needed types are not already defined in the typesystem repository (<a href="https://github.com/texttechnologylab/UIMATypeSystem">UIMATypeSystem</a>).
The typesystem for the fact-checking tool is defined in the following XML format:</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;typeSystemDescription</span> <span class="na">xmlns=</span><span class="s">"http://uima.apache.org/resourceSpecifier"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;name&gt;</span>TypeSystemFactChecking<span class="nt">&lt;/name&gt;</span>
    <span class="nt">&lt;description/&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.0<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;vendor/&gt;</span>
    <span class="c">&lt;!-- Imports of all needed Types --&gt;</span>
    <span class="nt">&lt;imports&gt;</span>
        <span class="nt">&lt;import</span> <span class="na">name=</span><span class="s">"desc.type.TextTechnologyDokumentAnnotation"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;import</span> <span class="na">name=</span><span class="s">"desc.type.TextTechnologyAnnotation"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;import</span> <span class="na">name=</span><span class="s">"desc.type.TypeSystemModelMeta"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;import</span> <span class="na">name=</span><span class="s">"desc.type.TypeSystemModelAnnotation"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/imports&gt;</span>
    <span class="nt">&lt;types&gt;</span>
        <span class="c">&lt;!--
            Needed Input Types for Fact-Checking.
            The Claim inheritance from Annotation.
            Note that every child gets the features of the parent.
        --&gt;</span>
        <span class="nt">&lt;typeDescription&gt;</span>
            <span class="nt">&lt;name&gt;</span>org.texttechnologylab.annotation.Claim<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;description&gt;</span> One Claim for different facts <span class="nt">&lt;/description&gt;</span>
            <span class="nt">&lt;supertypeName&gt;</span>uima.tcas.Annotation<span class="nt">&lt;/supertypeName&gt;</span>
            <span class="nt">&lt;features&gt;</span>
                <span class="c">&lt;!-- Information of Claim like the source--&gt;</span>
                <span class="nt">&lt;featureDescription&gt;</span>
                    <span class="nt">&lt;name&gt;</span>value<span class="nt">&lt;/name&gt;</span>
                    <span class="nt">&lt;description&gt;</span>Information of Claim<span class="nt">&lt;/description&gt;</span>
                    <span class="nt">&lt;rangeTypeName&gt;</span>uima.cas.String<span class="nt">&lt;/rangeTypeName&gt;</span>
                <span class="nt">&lt;/featureDescription&gt;</span>
                <span class="c">&lt;!-- Set of Fact --&gt;</span>
                <span class="nt">&lt;featureDescription&gt;</span>
                    <span class="nt">&lt;name&gt;</span>Facts<span class="nt">&lt;/name&gt;</span>
                    <span class="nt">&lt;description&gt;</span>Set of Fact<span class="nt">&lt;/description&gt;</span>
                    <span class="nt">&lt;rangeTypeName&gt;</span>uima.cas.FSArray<span class="nt">&lt;/rangeTypeName&gt;</span>
                    <span class="nt">&lt;elementType&gt;</span>org.texttechnologylab.annotation.Fact<span class="nt">&lt;/elementType&gt;</span>
                <span class="nt">&lt;/featureDescription&gt;</span>
            <span class="nt">&lt;/features&gt;</span>
        <span class="nt">&lt;/typeDescription&gt;</span>
        
        <span class="c">&lt;!--
            Needed Input Types for Fact-Checking.
            Fact inheritance from Annotation.
        --&gt;</span>
        <span class="nt">&lt;typeDescription&gt;</span>
            <span class="nt">&lt;name&gt;</span>org.texttechnologylab.annotation.Fact<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;description&gt;</span> One Fact for different claims <span class="nt">&lt;/description&gt;</span>
            <span class="nt">&lt;supertypeName&gt;</span>uima.tcas.Annotation<span class="nt">&lt;/supertypeName&gt;</span>
            <span class="nt">&lt;features&gt;</span>
                <span class="c">&lt;!-- Information of Fact like the source--&gt;</span>
                <span class="nt">&lt;featureDescription&gt;</span>
                    <span class="nt">&lt;name&gt;</span>value<span class="nt">&lt;/name&gt;</span>
                    <span class="nt">&lt;description&gt;</span>Information for the fact<span class="nt">&lt;/description&gt;</span>
                    <span class="nt">&lt;rangeTypeName&gt;</span>uima.cas.String<span class="nt">&lt;/rangeTypeName&gt;</span>
                <span class="nt">&lt;/featureDescription&gt;</span>
                <span class="c">&lt;!-- Set of Claims --&gt;</span>
                <span class="nt">&lt;featureDescription&gt;</span>
                    <span class="nt">&lt;name&gt;</span>Claims<span class="nt">&lt;/name&gt;</span>
                    <span class="nt">&lt;description&gt;</span>Set of Claims<span class="nt">&lt;/description&gt;</span>
                    <span class="nt">&lt;rangeTypeName&gt;</span>uima.cas.FSArray<span class="nt">&lt;/rangeTypeName&gt;</span>
                    <span class="nt">&lt;elementType&gt;</span>org.texttechnologylab.annotation.Claim<span class="nt">&lt;/elementType&gt;</span>
                <span class="nt">&lt;/featureDescription&gt;</span>
            <span class="nt">&lt;/features&gt;</span>
        <span class="nt">&lt;/typeDescription&gt;</span>
        
        <span class="c">&lt;!-- 
        Needed Output Types for Fact-Checking.
        MetaData inheritance from model.MetaData, which save in CAS document which tool annotated the claim fact pair.
        --&gt;</span>
        <span class="nt">&lt;typeDescription&gt;</span>
            <span class="nt">&lt;name&gt;</span>org.texttechnologylab.annotation.model.FactCheckingMetaData<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;description/&gt;</span>
            <span class="nt">&lt;supertypeName&gt;</span>org.texttechnologylab.annotation.model.MetaData<span class="nt">&lt;/supertypeName&gt;</span>
            <span class="nt">&lt;features&gt;</span>
                <span class="nt">&lt;featureDescription&gt;</span>
                    <span class="nt">&lt;name&gt;</span>DependeciesVersion<span class="nt">&lt;/name&gt;</span>
                    <span class="nt">&lt;description&gt;</span>Dependency Library Version e.g. Pytorch...<span class="nt">&lt;/description&gt;</span>
                    <span class="nt">&lt;rangeTypeName&gt;</span>uima.cas.StringArray<span class="nt">&lt;/rangeTypeName&gt;</span>
                <span class="nt">&lt;/featureDescription&gt;</span>
            <span class="nt">&lt;/features&gt;</span>
        <span class="nt">&lt;/typeDescription&gt;</span>
        
        <span class="c">&lt;!--
            Needed Output Types for Fact-Checking
            FactChecking inheritance from Annotation
        --&gt;</span>
        <span class="nt">&lt;typeDescription&gt;</span>
            <span class="nt">&lt;name&gt;</span>org.texttechnologylab.annotation.FactChecking<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;description&gt;</span> Does the assertion confirm the statement <span class="nt">&lt;/description&gt;</span>
            <span class="nt">&lt;supertypeName&gt;</span>uima.tcas.Annotation<span class="nt">&lt;/supertypeName&gt;</span>
            <span class="nt">&lt;features&gt;</span>
                <span class="c">&lt;!-- The Fact that is checked --&gt;</span>
                <span class="nt">&lt;featureDescription&gt;</span>
                    <span class="nt">&lt;name&gt;</span>Fact<span class="nt">&lt;/name&gt;</span>
                    <span class="nt">&lt;description/&gt;</span>
                    <span class="nt">&lt;rangeTypeName&gt;</span>org.texttechnologylab.annotation.Fact<span class="nt">&lt;/rangeTypeName&gt;</span>
                <span class="nt">&lt;/featureDescription&gt;</span>
                <span class="c">&lt;!-- The Claim that is checked --&gt;</span>
                <span class="nt">&lt;featureDescription&gt;</span>
                    <span class="nt">&lt;name&gt;</span>Claim<span class="nt">&lt;/name&gt;</span>
                    <span class="nt">&lt;description/&gt;</span>
                    <span class="nt">&lt;rangeTypeName&gt;</span>org.texttechnologylab.annotation.Claim<span class="nt">&lt;/rangeTypeName&gt;</span>
                <span class="nt">&lt;/featureDescription&gt;</span>
                <span class="c">&lt;!-- The result of the check --&gt;</span>
                <span class="nt">&lt;featureDescription&gt;</span>
                    <span class="nt">&lt;name&gt;</span>consistency<span class="nt">&lt;/name&gt;</span>
                    <span class="nt">&lt;description/&gt;</span>
                    <span class="nt">&lt;rangeTypeName&gt;</span>uima.cas.Double<span class="nt">&lt;/rangeTypeName&gt;</span>
                <span class="nt">&lt;/featureDescription&gt;</span>
                
                <span class="c">&lt;!-- 
                    The Reference for the used tool, so that the user can see which tool was used for the annotation.
                    It is important for the reproducibility of the analysis.
                --&gt;</span>
                <span class="nt">&lt;featureDescription&gt;</span>
                    <span class="nt">&lt;name&gt;</span>model<span class="nt">&lt;/name&gt;</span>
                    <span class="nt">&lt;description/&gt;</span>
                    <span class="nt">&lt;rangeTypeName&gt;</span>org.texttechnologylab.annotation.model.MetaData<span class="nt">&lt;/rangeTypeName&gt;</span>
                <span class="nt">&lt;/featureDescription&gt;</span>
            <span class="nt">&lt;/features&gt;</span>
        <span class="nt">&lt;/typeDescription&gt;</span>
    <span class="nt">&lt;/types&gt;</span>
<span class="nt">&lt;/typeSystemDescription&gt;</span>
</code></pre></div></div>

<h2 id="factchecking-integration-in-the-duui-pipeline-with-python">FactChecking Integration in the DUUI Pipeline with Python</h2>
<p>After defining the typesystem, we can integrate the fact-checking tool into the DUUI pipeline.
The of the fact-checking tool is implemented in python.
Install the needed packages with the following command, after creating a virtual environment(via conda) with python 3.8 in IntelliJ.<br />
<code class="language-plaintext highlighter-rouge">pip install -r requirements.txt</code><br />
The following code snippet shows how to integrate the fact-checking tool into the DUUI pipeline `duui-FactCheckingTest/src/main/python/duui_fact.py.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="n">pydantic_settings</span> <span class="kn">import</span> <span class="n">BaseSettings</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span> <span class="n">logging</span>
<span class="kn">from</span> <span class="n">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="n">cassis</span> <span class="kn">import</span> <span class="n">load_typesystem</span>
<span class="kn">import</span> <span class="n">torch</span>
<span class="kn">from</span> <span class="n">functools</span> <span class="kn">import</span> <span class="n">lru_cache</span>
<span class="c1"># Import the fact-checking tools from the factchecker.py, which is in the same directory will be explained in the next step.
</span><span class="kn">from</span> <span class="n">factchecker</span> <span class="kn">import</span> <span class="n">UniEvalFactCheck</span><span class="p">,</span> <span class="n">NubiaFactCheck</span>
<span class="kn">from</span> <span class="n">threading</span> <span class="kn">import</span> <span class="n">Lock</span>
<span class="c1"># from sp_correction import SentenceBestPrediction
</span>
<span class="c1"># Settings
# These are automatically loaded from env variables
</span><span class="kn">from</span> <span class="n">starlette.responses</span> <span class="kn">import</span> <span class="n">PlainTextResponse</span>

<span class="n">model_lock</span> <span class="o">=</span> <span class="nc">Lock</span><span class="p">()</span>

<span class="c1"># Sources of the models for the meta information
# It is important for the reproducibility of the analysis and needed because the user can see which tool was used for the annotation.
</span><span class="n">sources</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">nubia</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">https://github.com/wl-research/nubia</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">unieval</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">https://github.com/maszhongming/UniEval</span><span class="sh">"</span>
<span class="p">}</span>

<span class="c1"># Languages of the models for the meta information and needed because the user can see which tool was used for the annotation.
</span><span class="n">languages</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">nubia</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">en</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">unieval</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">en</span><span class="sh">"</span>
<span class="p">}</span>


<span class="k">class</span> <span class="nc">Settings</span><span class="p">(</span><span class="n">BaseSettings</span><span class="p">):</span>
    <span class="c1"># Name of this annotator
</span>    <span class="n">fact_annotator_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1"># Version of this annotator
</span>    <span class="n">fact_annotator_version</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1"># Log level
</span>    <span class="n">fact_log_level</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1"># model_name in this case nubia or unieval
</span>    <span class="n">fact_model_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1"># Version of the model used by this annotator
</span>    <span class="n">fact_model_version</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1"># cach_size for the model
</span>    <span class="n">fact_model_cache_size</span><span class="p">:</span> <span class="nb">int</span>


<span class="c1"># Load settings from env vars
</span><span class="n">settings</span> <span class="o">=</span> <span class="nc">Settings</span><span class="p">()</span>
<span class="n">lru_cache_with_size</span> <span class="o">=</span> <span class="nf">lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">fact_model_cache_size</span><span class="p">)</span>
<span class="c1"># Set up logging with the specified log level from the settings
</span><span class="n">logging</span><span class="p">.</span><span class="nf">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">fact_log_level</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="nf">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="c1"># Set device to GPU if available
</span><span class="n">device</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="nf">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="sh">"</span><span class="s">cpu</span><span class="sh">"</span>
<span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">USING </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># Load the predefined typesystem that is needed for this annotator to work
</span><span class="n">typesystem_filename</span> <span class="o">=</span> <span class="sh">'</span><span class="s">TypeSystemFactChecking.xml</span><span class="sh">'</span>
<span class="n">logger</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sh">"</span><span class="s">Loading typesystem from </span><span class="se">\"</span><span class="s">%s</span><span class="se">\"</span><span class="sh">"</span><span class="p">,</span> <span class="n">typesystem_filename</span><span class="p">)</span>
<span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">typesystem_filename</span><span class="p">,</span> <span class="sh">'</span><span class="s">rb</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">typesystem</span> <span class="o">=</span> <span class="nf">load_typesystem</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sh">"</span><span class="s">Base typesystem:</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="n">typesystem</span><span class="p">.</span><span class="nf">to_xml</span><span class="p">())</span>

<span class="c1"># Load the Lua communication script
</span><span class="n">lua_communication_script_filename</span> <span class="o">=</span> <span class="sh">"</span><span class="s">duui_fact.lua</span><span class="sh">"</span>
<span class="n">logger</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sh">"</span><span class="s">Loading Lua communication script from </span><span class="se">\"</span><span class="s">%s</span><span class="se">\"</span><span class="sh">"</span><span class="p">,</span> <span class="n">lua_communication_script_filename</span><span class="p">)</span>


<span class="c1"># Request sent by DUUI
# Note, this is transformed by the Lua script
</span><span class="k">class</span> <span class="nc">DUUIRequest</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="c1"># List of Claims every claim element is a dictionary with following Infos: text, begin, end and facts(to check the claim with the facts)
</span>    <span class="n">claims_all</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c1"># List of Facts every fact element is a dictionary with following Infos: text, begin, end and claims(to check the fact with the claims)
</span>    <span class="n">facts_all</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c1"># Optional map/dict of parameters
</span>    <span class="n">parameters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>


<span class="c1"># UIMA type: mark modification of the document 
# This is used to store the modification meta information in the CAS, for example who annotated the document, when and with which tool
</span><span class="k">class</span> <span class="nc">DocumentModification</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">user</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">comment</span><span class="p">:</span> <span class="nb">str</span>


<span class="c1"># UIMA type: adds metadata to each annotation
# This is used to store the meta information in the CAS, for example which tool was used for the annotation and which version of the tool was used.
# It is important for the reproducibility of the analysis.
</span><span class="k">class</span> <span class="nc">AnnotationMeta</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">version</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">modelName</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">modelVersion</span><span class="p">:</span> <span class="nb">str</span>


<span class="c1"># Response sent by DUUI
# Note, this is transformed by the Lua script
# Output of the fact-checking tool
</span><span class="k">class</span> <span class="nc">DUUIResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="c1"># Meta information, one per document
</span>    <span class="n">meta</span><span class="p">:</span> <span class="n">AnnotationMeta</span>
    <span class="c1"># Modification meta, one per document
</span>    <span class="n">modification_meta</span><span class="p">:</span> <span class="n">DocumentModification</span>
    <span class="c1"># List of consistencies for each claim-fact pair
</span>    <span class="c1"># List of begin positions of the claims needed for finding the claim in the CAS
</span>    <span class="n">begin_claims</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="c1"># List of end positions of the claims needed for finding the claim in the CAS
</span>    <span class="n">end_claims</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="c1"># List of begin positions of the facts needed for finding the fact in the CAS
</span>    <span class="n">begin_facts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="c1"># List of end positions of the facts needed for finding the fact in the CAS
</span>    <span class="n">end_facts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="c1"># List of consistencies for each claim-fact pair
</span>    <span class="n">consistency</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
    <span class="c1"># Model information
</span>    <span class="c1"># Needed for the reproducibility of the analysis that every annotation has the information which tool was used for the annotation.
</span>    <span class="c1"># Name of the model used for the annotation, for example nubia or unieval
</span>    <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1"># Version of the model used for the annotation
</span>    <span class="n">model_version</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1"># Source of the model used for the annotation
</span>    <span class="n">model_source</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1"># Language of the model used for the annotation
</span>    <span class="n">model_lang</span><span class="p">:</span> <span class="nb">str</span>

<span class="c1"># REST API definition with FastAPI
</span><span class="n">app</span> <span class="o">=</span> <span class="nc">FastAPI</span><span class="p">(</span>
    <span class="n">openapi_url</span><span class="o">=</span><span class="sh">"</span><span class="s">/openapi.json</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">docs_url</span><span class="o">=</span><span class="sh">"</span><span class="s">/api</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">redoc_url</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">fact_annotator_name</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Factuality annotator</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">version</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">fact_model_version</span><span class="p">,</span>
    <span class="n">terms_of_service</span><span class="o">=</span><span class="sh">"</span><span class="s">https://www.texttechnologylab.org/legal_notice/</span><span class="sh">"</span><span class="p">,</span>
    <span class="c1"># Contact of creator
</span>    <span class="n">contact</span><span class="o">=</span><span class="p">{</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">TTLab Team</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">https://texttechnologylab.org</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">email</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">bagci@em.uni-frankfurt.de</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">license_info</span><span class="o">=</span><span class="p">{</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">AGPL</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">http://www.gnu.org/licenses/agpl-3.0.en.html</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span>

<span class="c1"># Reading Lua communication script
</span><span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">lua_communication_script_filename</span><span class="p">,</span> <span class="sh">'</span><span class="s">rb</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">lua_communication_script</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>
<span class="n">logger</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sh">"</span><span class="s">Lua communication script:</span><span class="sh">"</span><span class="p">)</span>
<span class="n">logger</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="n">lua_communication_script_filename</span><span class="p">)</span>


<span class="c1"># Get typesystem of this tool
</span><span class="nd">@app.get</span><span class="p">(</span><span class="sh">"</span><span class="s">/v1/typesystem</span><span class="sh">"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_typesystem</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="n">xml</span> <span class="o">=</span> <span class="n">typesystem</span><span class="p">.</span><span class="nf">to_xml</span><span class="p">()</span>
    <span class="n">xml_content</span> <span class="o">=</span> <span class="n">xml</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">return</span> <span class="nc">Response</span><span class="p">(</span>
        <span class="n">content</span><span class="o">=</span><span class="n">xml_content</span><span class="p">,</span>
        <span class="n">media_type</span><span class="o">=</span><span class="sh">"</span><span class="s">application/xml</span><span class="sh">"</span>
    <span class="p">)</span>


<span class="c1"># Return Lua communication script
</span><span class="nd">@app.get</span><span class="p">(</span><span class="sh">"</span><span class="s">/v1/communication_layer</span><span class="sh">"</span><span class="p">,</span> <span class="n">response_class</span><span class="o">=</span><span class="n">PlainTextResponse</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_communication_layer</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">lua_communication_script</span>


<span class="c1"># Return documentation info
</span><span class="nd">@app.get</span><span class="p">(</span><span class="sh">"</span><span class="s">/v1/documentation</span><span class="sh">"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_documentation</span><span class="p">():</span>
    <span class="k">return</span> <span class="sh">"</span><span class="s">This is Python RestAPI </span><span class="sh">"</span>


<span class="c1"># Process request from DUUI
</span><span class="nd">@app.post</span><span class="p">(</span><span class="sh">"</span><span class="s">/v1/process</span><span class="sh">"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">post_process</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">DUUIRequest</span><span class="p">):</span>
    <span class="c1"># Return data
</span>    <span class="n">meta</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c1"># Already checked claim-fact pairs
</span>    <span class="n">checkfacts</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Consistency of the claim-fact pair
</span>    <span class="n">consistency</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Begin and end positions of the claims and facts
</span>    <span class="n">begin_claims</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">end_claims</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">begin_facts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">end_facts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Save modification start time for later
</span>    <span class="n">modification_timestamp_seconds</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="nf">time</span><span class="p">())</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Get the model source and language
</span>        <span class="c1"># Needed for the reproducibility of the analysis that every annotation has the information which tool was used for the annotation.
</span>        <span class="c1"># Normally DUUI is atomar for each model, however it is possible to use multiple models in one DUUI instance.
</span>        <span class="c1"># In this case, the source and language of the model is needed for every call.
</span>        <span class="n">model_source</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="n">settings</span><span class="p">.</span><span class="n">fact_model_name</span><span class="p">]</span>
        <span class="n">model_lang</span> <span class="o">=</span> <span class="n">languages</span><span class="p">[</span><span class="n">settings</span><span class="p">.</span><span class="n">fact_model_name</span><span class="p">]</span>
        <span class="c1"># Add meta info to the response for the user to see which tool was used for the annotation and which version of the tool was used.
</span>        <span class="c1"># Like Prevoiusly mentioned it change for every call, if multiple models are used in one DUUI instance.
</span>        <span class="n">meta</span> <span class="o">=</span> <span class="nc">AnnotationMeta</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">fact_annotator_name</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">fact_annotator_version</span><span class="p">,</span>
            <span class="n">modelName</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">fact_model_name</span><span class="p">,</span>
            <span class="n">modelVersion</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">fact_model_version</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Add modification info
</span>        <span class="n">modification_meta_comment</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">settings</span><span class="p">.</span><span class="n">fact_annotator_name</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">settings</span><span class="p">.</span><span class="n">fact_annotator_version</span><span class="si">}</span><span class="s">))</span><span class="sh">"</span>
        <span class="n">modification_meta</span> <span class="o">=</span> <span class="nc">DocumentModification</span><span class="p">(</span>
            <span class="n">user</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">fact_annotator_name</span><span class="p">,</span>
            <span class="n">timestamp</span><span class="o">=</span><span class="n">modification_timestamp_seconds</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="n">modification_meta_comment</span>
        <span class="p">)</span>
        <span class="c1"># Get the claims and facts from the request, which were transformed by the Lua script in the Serilization.
</span>        <span class="n">claims</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">claims_all</span>
        <span class="n">facts</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">facts_all</span>
        <span class="c1"># Model loading and checking
</span>        <span class="k">with</span> <span class="n">model_lock</span><span class="p">:</span>
            <span class="c1"># Load the model
</span>            <span class="n">model_run</span> <span class="o">=</span> <span class="nf">load_model</span><span class="p">(</span><span class="n">settings</span><span class="p">.</span><span class="n">fact_model_name</span><span class="p">)</span>
            <span class="n">claim_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">fact_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">counters</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># get the claim_list and fact_list
</span>            <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">claim</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">claims</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">fc</span><span class="p">,</span> <span class="n">fact_i</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">claim</span><span class="p">[</span><span class="sh">"</span><span class="s">facts</span><span class="sh">"</span><span class="p">]):</span>
                    <span class="n">claim_list</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">claim</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">])</span>
                    <span class="n">fact_list</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">fact_i</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">])</span>
                    <span class="c1"># Needed to identify the claim-fact pair
</span>                    <span class="n">counters</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">fc</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="c1"># Compute every pair of claim and fact
</span>            <span class="n">factchecked</span> <span class="o">=</span> <span class="n">model_run</span><span class="p">.</span><span class="nf">check</span><span class="p">(</span><span class="n">claim_list</span><span class="p">,</span> <span class="n">fact_list</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">fact_check_i</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">factchecked</span><span class="p">):</span>
                <span class="n">checkfacts</span><span class="p">[</span><span class="n">counters</span><span class="p">[</span><span class="n">c</span><span class="p">]]</span> <span class="o">=</span> <span class="n">fact_check_i</span>
            <span class="c1"># check fact_list
</span>            <span class="n">claim_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">fact_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">counters</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">factscheck</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># must be checked in both directions claim-fact and fact-claim
</span>            <span class="k">for</span> <span class="n">fc</span><span class="p">,</span> <span class="n">fact_i</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">facts</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">claim</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">fact_i</span><span class="p">[</span><span class="sh">"</span><span class="s">claims</span><span class="sh">"</span><span class="p">]):</span>
                    <span class="c1"># Skip the claim-fact pair if it was already checked
</span>                    <span class="k">if</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">fc</span><span class="si">}</span><span class="sh">"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">checkfacts</span><span class="p">:</span>
                        <span class="n">claim_list</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">claim</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">])</span>
                        <span class="n">fact_list</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">fact_i</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">])</span>
                        <span class="n">counters</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">fc</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">claim_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">factchecked</span> <span class="o">=</span> <span class="n">model_run</span><span class="p">.</span><span class="nf">check</span><span class="p">(</span><span class="n">claim_list</span><span class="p">,</span> <span class="n">fact_list</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">factchecked</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">fact_check_i</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">factchecked</span><span class="p">):</span>
                <span class="n">factscheck</span><span class="p">[</span><span class="n">counters</span><span class="p">[</span><span class="n">c</span><span class="p">]]</span> <span class="o">=</span> <span class="n">fact_check_i</span>
            <span class="k">for</span> <span class="n">key_i</span> <span class="ow">in</span> <span class="n">checkfacts</span><span class="p">:</span>
                <span class="c1"># Get the position of the claim and fact in list
</span>                <span class="n">key_claim</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">key_i</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">_</span><span class="sh">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">key_facts</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">key_i</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">_</span><span class="sh">"</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                <span class="c1"># Get the consistency of the claim-fact pair
</span>                <span class="n">cons</span> <span class="o">=</span> <span class="n">checkfacts</span><span class="p">[</span><span class="n">key_i</span><span class="p">][</span><span class="sh">'</span><span class="s">consistency</span><span class="sh">'</span><span class="p">]</span>
                <span class="c1"># Save the begin, end position and the fact-checking result
</span>                <span class="n">consistency</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">cons</span><span class="p">)</span>
                <span class="n">claim_i</span> <span class="o">=</span> <span class="n">claims</span><span class="p">[</span><span class="n">key_claim</span><span class="p">]</span>
                <span class="c1"># Get the begin and end position of the claim
</span>                <span class="n">begin_claims</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">claim_i</span><span class="p">[</span><span class="sh">"</span><span class="s">begin</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">end_claims</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">claim_i</span><span class="p">[</span><span class="sh">"</span><span class="s">end</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">fact_i</span> <span class="o">=</span> <span class="n">claim_i</span><span class="p">[</span><span class="sh">"</span><span class="s">facts</span><span class="sh">"</span><span class="p">][</span><span class="n">key_facts</span><span class="p">]</span>
                <span class="n">begin_facts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">fact_i</span><span class="p">[</span><span class="sh">"</span><span class="s">begin</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">end_facts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">fact_i</span><span class="p">[</span><span class="sh">"</span><span class="s">end</span><span class="sh">"</span><span class="p">])</span>
            <span class="c1"># save for both direction
</span>            <span class="k">for</span> <span class="n">key_i</span> <span class="ow">in</span> <span class="n">factscheck</span><span class="p">:</span>
                <span class="n">key_claim</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">key_i</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">_</span><span class="sh">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">key_facts</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">key_i</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">_</span><span class="sh">"</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">cons</span> <span class="o">=</span> <span class="n">checkfacts</span><span class="p">[</span><span class="n">key_i</span><span class="p">][</span><span class="sh">'</span><span class="s">consistency</span><span class="sh">'</span><span class="p">]</span>
                <span class="n">consistency</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">cons</span><span class="p">)</span>
                <span class="n">fact_i</span> <span class="o">=</span> <span class="n">facts</span><span class="p">[</span><span class="n">key_facts</span><span class="p">]</span>
                <span class="n">claim_i</span> <span class="o">=</span> <span class="n">fact_i</span><span class="p">[</span><span class="sh">"</span><span class="s">claims</span><span class="sh">"</span><span class="p">][</span><span class="n">key_claim</span><span class="p">]</span>
                <span class="n">begin_claims</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">claim_i</span><span class="p">[</span><span class="sh">"</span><span class="s">begin</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">end_claims</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">claim_i</span><span class="p">[</span><span class="sh">"</span><span class="s">end</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">begin_facts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">fact_i</span><span class="p">[</span><span class="sh">"</span><span class="s">begin</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">end_facts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">fact_i</span><span class="p">[</span><span class="sh">"</span><span class="s">end</span><span class="sh">"</span><span class="p">])</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="c1"># Log exception
</span>        <span class="n">logger</span><span class="p">.</span><span class="nf">exception</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
    <span class="c1"># Return the response to the DUUI with the meta information, modification meta information, consistency, begin and end positions of the claims and facts and model information
</span>    <span class="k">return</span> <span class="nc">DUUIResponse</span><span class="p">(</span><span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">,</span> <span class="n">modification_meta</span><span class="o">=</span><span class="n">modification_meta</span><span class="p">,</span> <span class="n">consistency</span><span class="o">=</span><span class="n">consistency</span><span class="p">,</span>
                        <span class="n">begin_claims</span><span class="o">=</span><span class="n">begin_claims</span><span class="p">,</span> <span class="n">end_claims</span><span class="o">=</span><span class="n">end_claims</span><span class="p">,</span> <span class="n">begin_facts</span><span class="o">=</span><span class="n">begin_facts</span><span class="p">,</span> <span class="n">end_facts</span><span class="o">=</span><span class="n">end_facts</span><span class="p">,</span>
                        <span class="n">model_name</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">fact_model_name</span><span class="p">,</span> <span class="n">model_version</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">fact_model_version</span><span class="p">,</span>
                        <span class="n">model_source</span><span class="o">=</span><span class="n">model_source</span><span class="p">,</span> <span class="n">model_lang</span><span class="o">=</span><span class="n">model_lang</span><span class="p">)</span>

<span class="c1"># Load the model with the lru_cache with the size of the cache_size from the settings file
# The model is loaded only once and then stored in the cache.
</span><span class="nd">@lru_cache_with_size</span>
<span class="k">def</span> <span class="nf">load_model</span><span class="p">(</span><span class="n">model_name</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">model_name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">nubia</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">model_i</span> <span class="o">=</span> <span class="nc">NubiaFactCheck</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">model_i</span> <span class="o">=</span> <span class="nc">UniEvalFactCheck</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model_i</span>
</code></pre></div></div>
<p>The fact checking tool can be implemented also in the main python file, but it is possible to implement it in a separate file and test it separately, before integrating it into the DUUI pipeline.
The fact-checking tool is implemented in the factchecker.py file in the same directory as the duui_fact.py file.
The following code snippet shows the implementation of the fact-checking tool in the factchecker.py file.
The imports <code class="language-plaintext highlighter-rouge">evaluator.py</code>, <code class="language-plaintext highlighter-rouge">scorer.py</code> and <code class="language-plaintext highlighter-rouge">utils.py</code> are the implementation of the fact-checking tool UniEval (<a href="https://aclanthology.org/2022.emnlp-main.131/">Zhong et al. 2022</a>) from their repository (<a href="https://github.com/maszhongming/UniEval">UniEval</a>).</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">utils</span> <span class="kn">import</span> <span class="n">convert_to_json</span>
<span class="kn">from</span> <span class="n">evaluator</span> <span class="kn">import</span> <span class="n">get_evaluator</span>
<span class="kn">from</span> <span class="n">nubia_score</span> <span class="kn">import</span> <span class="n">Nubia</span>
<span class="kn">import</span> <span class="n">torch</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">List</span>


<span class="k">class</span> <span class="nc">NubiaFactCheck</span><span class="p">:</span>
    <span class="c1"># Load the Nubia model only runs with CPU
</span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Loading Nubia...</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">nubia</span> <span class="o">=</span> <span class="nc">Nubia</span><span class="p">()</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Nubia loaded.</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># Check the claim with the evidence
</span>    <span class="k">def</span> <span class="nf">check_i</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">claim</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">evidence</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">six_dim</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">aggregator</span><span class="o">=</span><span class="sh">"</span><span class="s">agg_two</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">nubia</span><span class="p">.</span><span class="nf">score</span><span class="p">(</span><span class="n">claim</span><span class="p">,</span> <span class="n">evidence</span><span class="p">,</span> <span class="n">get_features</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">six_dim</span><span class="o">=</span><span class="n">six_dim</span><span class="p">,</span> <span class="n">aggregator</span><span class="o">=</span><span class="n">aggregator</span><span class="p">)</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">scores</span><span class="p">[</span><span class="sh">"</span><span class="s">features</span><span class="sh">"</span><span class="p">].</span><span class="nf">items</span><span class="p">()}</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">consistency</span><span class="sh">"</span><span class="p">:</span> <span class="n">scores</span><span class="p">[</span><span class="sh">"</span><span class="s">nubia_score</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">Labels</span><span class="sh">"</span><span class="p">:</span> <span class="n">labels</span><span class="p">}</span>

    <span class="c1"># Checks a list of claims and facts, each claim is checked with the corresponding fact via the index
</span>    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">claims</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">evidences</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">six_dim</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">aggregator</span><span class="o">=</span><span class="sh">"</span><span class="s">agg_two</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">out_i</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">claim_i</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">claims</span><span class="p">):</span>
            <span class="n">fact_i</span> <span class="o">=</span> <span class="n">evidences</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
            <span class="n">out_i</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">check_i</span><span class="p">(</span><span class="n">claim_i</span><span class="p">,</span> <span class="n">fact_i</span><span class="p">,</span> <span class="n">six_dim</span><span class="p">,</span> <span class="n">aggregator</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">out_i</span>


<span class="k">class</span> <span class="nc">UniEvalFactCheck</span><span class="p">:</span>
    <span class="c1"># Intialisation UniEval
</span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="sh">"</span><span class="s">cpu</span><span class="sh">"</span><span class="p">):</span>
        <span class="c1"># Set the device GPU(cuda) or CPU
</span>        <span class="n">self</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
        <span class="c1"># Load the UniEval model fact for the fact-checking
</span>        <span class="n">self</span><span class="p">.</span><span class="n">evaluator</span> <span class="o">=</span> <span class="nf">get_evaluator</span><span class="p">(</span><span class="sh">"</span><span class="s">fact</span><span class="sh">"</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">device</span><span class="p">)</span>

    <span class="c1"># Compute the consistency of the claims the facts, each claim is checked with the corresponding fact via the index
</span>    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">claim</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">evidence</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">convert_to_json</span><span class="p">(</span><span class="n">output_list</span><span class="o">=</span><span class="n">claim</span><span class="p">,</span> <span class="n">src_list</span><span class="o">=</span><span class="n">evidence</span><span class="p">)</span>
        <span class="n">eval_scores</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">evaluator</span><span class="p">.</span><span class="nf">evaluate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">print_result</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">eval_scores</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="c1"># Test the fact-checking tool
</span>    <span class="n">_evidence</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
    Jane writes code for Huggingface.
    </span><span class="sh">"""</span>

    <span class="n">_claim</span> <span class="o">=</span> <span class="sh">'</span><span class="s">Jane is an engineer.</span><span class="sh">'</span>
    <span class="n">device_1</span> <span class="o">=</span> <span class="sh">"</span><span class="s">cuda:0</span><span class="sh">"</span> <span class="k">if</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="nf">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="sh">"</span><span class="s">cpu</span><span class="sh">"</span>
    <span class="n">evidence1</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
    Justine Tanya Bateman (born February 19, 1966) is an American writer, producer, and actress . She is best known for her regular role as Mallory Keaton on the sitcom Family Ties (1982 -- 1989). Until recently, Bateman ran a production and consulting company, SECTION 5 . In the fall of 2012, she started studying computer science at UCLA.
    </span><span class="sh">"""</span>
    <span class="n">claim1</span> <span class="o">=</span> <span class="sh">'</span><span class="s">Justine Bateman is a producer.</span><span class="sh">'</span>
    <span class="c1"># factchecking = FactCheck()
</span>    <span class="c1"># print(factchecking.all_check(claim1, evidence1))
</span>    <span class="c1"># print(factchecking.all_check(_claim, _evidence))
</span>    <span class="n">unicheck</span> <span class="o">=</span> <span class="nc">UniEvalFactCheck</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device_1</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">unicheck</span><span class="p">.</span><span class="nf">check</span><span class="p">([</span><span class="n">evidence1</span><span class="p">],</span> <span class="p">[</span><span class="n">claim1</span><span class="p">]))</span>
    <span class="n">nubiacheck</span> <span class="o">=</span> <span class="nc">NubiaFactCheck</span><span class="p">()</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">nubiacheck</span><span class="p">.</span><span class="nf">check_i</span><span class="p">(</span><span class="n">claim1</span><span class="p">,</span> <span class="n">evidence1</span><span class="p">))</span>
</code></pre></div></div>
<h2 id="lua">Lua</h2>
<p>The Lua script is used to transform the request and response from the DUUI pipeline of the CAS document to the REST API.</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Bind static classes from java to lua variables</span>
<span class="n">StandardCharsets</span> <span class="o">=</span> <span class="n">luajava</span><span class="p">.</span><span class="n">bindClass</span><span class="p">(</span><span class="s2">"java.nio.charset.StandardCharsets"</span><span class="p">)</span>
<span class="n">util</span> <span class="o">=</span> <span class="n">luajava</span><span class="p">.</span><span class="n">bindClass</span><span class="p">(</span><span class="s2">"org.apache.uima.fit.util.JCasUtil"</span><span class="p">)</span>
<span class="c1">-- Bind the classes from the typesystem to lua variables</span>
<span class="n">facts</span> <span class="o">=</span> <span class="n">luajava</span><span class="p">.</span><span class="n">bindClass</span><span class="p">(</span><span class="s2">"org.texttechnologylab.annotation.Fact"</span><span class="p">)</span>
<span class="n">claims</span> <span class="o">=</span> <span class="n">luajava</span><span class="p">.</span><span class="n">bindClass</span><span class="p">(</span><span class="s2">"org.texttechnologylab.annotation.Claim"</span><span class="p">)</span>
<span class="n">FactCheck</span> <span class="o">=</span> <span class="n">luajava</span><span class="p">.</span><span class="n">bindClass</span><span class="p">(</span><span class="s2">"org.texttechnologylab.annotation.FactChecking"</span><span class="p">)</span>

<span class="c1">-- This "serialize" function is called to transform the CAS object into an stream that is sent to the annotator</span>
<span class="c1">-- Inputs:</span>
<span class="c1">--  - inputCas: The actual CAS object to serialize</span>
<span class="c1">--  - outputStream: Stream that is sent to the annotator, can be e.g. a string, JSON payload, ...</span>
<span class="k">function</span> <span class="nf">serialize</span><span class="p">(</span><span class="n">inputCas</span><span class="p">,</span> <span class="n">outputStream</span><span class="p">)</span>
    <span class="c1">-- Get data from CAS</span>
    <span class="kd">local</span> <span class="n">doc_text</span> <span class="o">=</span> <span class="n">inputCas</span><span class="p">:</span><span class="n">getDocumentText</span><span class="p">()</span>
    <span class="kd">local</span> <span class="n">doc_lang</span> <span class="o">=</span> <span class="n">inputCas</span><span class="p">:</span><span class="n">getDocumentLanguage</span><span class="p">()</span>
    <span class="c1">-- Get all claims and facts from the CAS</span>
    <span class="kd">local</span> <span class="n">all_facts</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="kd">local</span> <span class="n">all_claims</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="kd">local</span> <span class="n">sen_counter</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1">-- Via Iterator get all claims and facts from the CAS</span>
    <span class="kd">local</span> <span class="n">claims_in</span> <span class="o">=</span> <span class="n">util</span><span class="p">:</span><span class="nb">select</span><span class="p">(</span><span class="n">inputCas</span><span class="p">,</span> <span class="n">claims</span><span class="p">):</span><span class="n">iterator</span><span class="p">()</span>
    <span class="c1">-- Until there are no more claims</span>
    <span class="k">while</span> <span class="n">claims_in</span><span class="p">:</span><span class="n">hasNext</span><span class="p">()</span> <span class="k">do</span>
        <span class="kd">local</span> <span class="n">claim</span> <span class="o">=</span> <span class="n">claims_in</span><span class="p">:</span><span class="nb">next</span><span class="p">()</span>
        <span class="c1">-- Claim inherits from Annotation, so we can use the methods of the Annotation class</span>
        <span class="c1">-- Get the begin and end position of the claim, needed to find the claim in the CAS</span>
        <span class="kd">local</span> <span class="n">begin_claim</span> <span class="o">=</span> <span class="n">claim</span><span class="p">:</span><span class="n">getBegin</span><span class="p">()</span>
        <span class="kd">local</span> <span class="n">end_claim</span> <span class="o">=</span> <span class="n">claim</span><span class="p">:</span><span class="n">getEnd</span><span class="p">()</span>
        <span class="c1">-- Get the text of the claim</span>
        <span class="kd">local</span> <span class="n">claim_text</span> <span class="o">=</span> <span class="n">claim</span><span class="p">:</span><span class="n">getCoveredText</span><span class="p">()</span>
        <span class="c1">-- Save the claim in the all_claims list</span>
        <span class="n">all_claims</span><span class="p">[</span><span class="n">sen_counter</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">all_claims</span><span class="p">[</span><span class="n">sen_counter</span><span class="p">][</span><span class="s2">"begin"</span><span class="p">]</span> <span class="o">=</span> <span class="n">begin_claim</span>
        <span class="n">all_claims</span><span class="p">[</span><span class="n">sen_counter</span><span class="p">][</span><span class="s2">"end"</span><span class="p">]</span> <span class="o">=</span> <span class="n">end_claim</span>
        <span class="n">all_claims</span><span class="p">[</span><span class="n">sen_counter</span><span class="p">][</span><span class="s2">"text"</span><span class="p">]</span> <span class="o">=</span> <span class="n">claim_text</span>
        <span class="n">all_claims</span><span class="p">[</span><span class="n">sen_counter</span><span class="p">][</span><span class="s2">"facts"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="kd">local</span> <span class="n">facts_in</span> <span class="o">=</span> <span class="n">claim</span><span class="p">:</span><span class="n">getFacts</span><span class="p">():</span><span class="n">iterator</span><span class="p">()</span>
        <span class="kd">local</span> <span class="n">fact_counter</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1">-- get every fact, which should be compared with the claim</span>
        <span class="k">while</span> <span class="n">facts_in</span><span class="p">:</span><span class="n">hasNext</span><span class="p">()</span> <span class="k">do</span>
            <span class="kd">local</span> <span class="n">fact</span> <span class="o">=</span> <span class="n">facts_in</span><span class="p">:</span><span class="nb">next</span><span class="p">()</span>
            <span class="kd">local</span> <span class="n">begin_fact</span> <span class="o">=</span> <span class="n">fact</span><span class="p">:</span><span class="n">getBegin</span><span class="p">()</span>
            <span class="kd">local</span> <span class="n">end_fact</span> <span class="o">=</span> <span class="n">fact</span><span class="p">:</span><span class="n">getEnd</span><span class="p">()</span>
            <span class="kd">local</span> <span class="n">fact_text</span> <span class="o">=</span> <span class="n">fact</span><span class="p">:</span><span class="n">getCoveredText</span><span class="p">()</span>
            <span class="n">all_claims</span><span class="p">[</span><span class="n">sen_counter</span><span class="p">][</span><span class="s2">"facts"</span><span class="p">][</span><span class="n">fact_counter</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">all_claims</span><span class="p">[</span><span class="n">sen_counter</span><span class="p">][</span><span class="s2">"facts"</span><span class="p">][</span><span class="n">fact_counter</span><span class="p">][</span><span class="s2">"begin"</span><span class="p">]</span> <span class="o">=</span> <span class="n">begin_fact</span>
            <span class="n">all_claims</span><span class="p">[</span><span class="n">sen_counter</span><span class="p">][</span><span class="s2">"facts"</span><span class="p">][</span><span class="n">fact_counter</span><span class="p">][</span><span class="s2">"end"</span><span class="p">]</span> <span class="o">=</span> <span class="n">end_fact</span>
            <span class="n">all_claims</span><span class="p">[</span><span class="n">sen_counter</span><span class="p">][</span><span class="s2">"facts"</span><span class="p">][</span><span class="n">fact_counter</span><span class="p">][</span><span class="s2">"text"</span><span class="p">]</span> <span class="o">=</span> <span class="n">fact_text</span>
            <span class="n">fact_counter</span> <span class="o">=</span> <span class="n">fact_counter</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">end</span>
        <span class="n">sen_counter</span> <span class="o">=</span> <span class="n">sen_counter</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">end</span>
    <span class="c1">-- both directions claim-fact and fact-claim</span>
    <span class="c1">-- same process as for the claims but for the facts</span>
    <span class="kd">local</span> <span class="n">fact_counter</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="kd">local</span> <span class="n">facts_in</span> <span class="o">=</span> <span class="n">util</span><span class="p">:</span><span class="nb">select</span><span class="p">(</span><span class="n">inputCas</span><span class="p">,</span> <span class="n">facts</span><span class="p">):</span><span class="n">iterator</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">facts_in</span><span class="p">:</span><span class="n">hasNext</span><span class="p">()</span> <span class="k">do</span>
        <span class="kd">local</span> <span class="n">fact_now</span> <span class="o">=</span> <span class="n">facts_in</span><span class="p">:</span><span class="nb">next</span><span class="p">()</span>
        <span class="kd">local</span> <span class="n">begin_fact</span> <span class="o">=</span> <span class="n">fact_now</span><span class="p">:</span><span class="n">getBegin</span><span class="p">()</span>
        <span class="kd">local</span> <span class="n">end_fact</span> <span class="o">=</span> <span class="n">fact_now</span><span class="p">:</span><span class="n">getEnd</span><span class="p">()</span>
        <span class="kd">local</span> <span class="n">fact_text</span> <span class="o">=</span> <span class="n">fact_now</span><span class="p">:</span><span class="n">getCoveredText</span><span class="p">()</span>
        <span class="n">all_facts</span><span class="p">[</span><span class="n">fact_counter</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">all_facts</span><span class="p">[</span><span class="n">fact_counter</span><span class="p">][</span><span class="s2">"begin"</span><span class="p">]</span> <span class="o">=</span> <span class="n">begin_fact</span>
        <span class="n">all_facts</span><span class="p">[</span><span class="n">fact_counter</span><span class="p">][</span><span class="s2">"end"</span><span class="p">]</span> <span class="o">=</span> <span class="n">end_fact</span>
        <span class="n">all_facts</span><span class="p">[</span><span class="n">fact_counter</span><span class="p">][</span><span class="s2">"text"</span><span class="p">]</span> <span class="o">=</span> <span class="n">fact_text</span>
        <span class="n">all_facts</span><span class="p">[</span><span class="n">fact_counter</span><span class="p">][</span><span class="s2">"claims"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="kd">local</span> <span class="n">claim_counter</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="kd">local</span> <span class="n">claims_in</span> <span class="o">=</span> <span class="n">fact_now</span><span class="p">:</span><span class="n">getClaims</span><span class="p">():</span><span class="n">iterator</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">claims_in</span><span class="p">:</span><span class="n">hasNext</span><span class="p">()</span> <span class="k">do</span>
            <span class="kd">local</span> <span class="n">claim</span> <span class="o">=</span> <span class="n">claims_in</span><span class="p">:</span><span class="nb">next</span><span class="p">()</span>
            <span class="kd">local</span> <span class="n">begin_claim</span> <span class="o">=</span> <span class="n">claim</span><span class="p">:</span><span class="n">getBegin</span><span class="p">()</span>
            <span class="kd">local</span> <span class="n">end_claim</span> <span class="o">=</span> <span class="n">claim</span><span class="p">:</span><span class="n">getEnd</span><span class="p">()</span>
            <span class="kd">local</span> <span class="n">claim_text</span> <span class="o">=</span> <span class="n">claim</span><span class="p">:</span><span class="n">getCoveredText</span><span class="p">()</span>
            <span class="n">all_facts</span><span class="p">[</span><span class="n">fact_counter</span><span class="p">][</span><span class="s2">"claims"</span><span class="p">][</span><span class="n">claim_counter</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">all_facts</span><span class="p">[</span><span class="n">fact_counter</span><span class="p">][</span><span class="s2">"claims"</span><span class="p">][</span><span class="n">claim_counter</span><span class="p">][</span><span class="s2">"begin"</span><span class="p">]</span> <span class="o">=</span> <span class="n">begin_claim</span>
            <span class="n">all_facts</span><span class="p">[</span><span class="n">fact_counter</span><span class="p">][</span><span class="s2">"claims"</span><span class="p">][</span><span class="n">claim_counter</span><span class="p">][</span><span class="s2">"end"</span><span class="p">]</span> <span class="o">=</span> <span class="n">end_claim</span>
            <span class="n">all_facts</span><span class="p">[</span><span class="n">fact_counter</span><span class="p">][</span><span class="s2">"claims"</span><span class="p">][</span><span class="n">claim_counter</span><span class="p">][</span><span class="s2">"text"</span><span class="p">]</span> <span class="o">=</span> <span class="n">claim_text</span>
            <span class="n">claim_counter</span> <span class="o">=</span> <span class="n">claim_counter</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">end</span>
        <span class="n">fact_counter</span> <span class="o">=</span> <span class="n">fact_counter</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">end</span>
    <span class="c1">-- the Inputs for the python process, note that names must be the same as in the python script duui_fact.py</span>
    <span class="n">outputStream</span><span class="p">:</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="n">encode</span><span class="p">({</span>
        <span class="n">claims_all</span> <span class="o">=</span> <span class="n">all_claims</span><span class="p">,</span>
        <span class="n">facts_all</span> <span class="o">=</span> <span class="n">all_facts</span>
    <span class="p">}))</span>
<span class="c1">-- --     print("sendToPython")</span>
<span class="k">end</span>

<span class="c1">-- This "deserialize" function is called on receiving the results from the annotator that have to be transformed into a CAS object</span>
<span class="c1">-- Inputs:</span>
<span class="c1">--  - inputCas: The actual CAS object to deserialize into</span>
<span class="c1">--  - inputStream: Stream that is received from to the annotator, can be e.g. a string, JSON payload, ...</span>
<span class="k">function</span> <span class="nf">deserialize</span><span class="p">(</span><span class="n">inputCas</span><span class="p">,</span> <span class="n">inputStream</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">inputString</span> <span class="o">=</span> <span class="n">luajava</span><span class="p">.</span><span class="n">newInstance</span><span class="p">(</span><span class="s2">"java.lang.String"</span><span class="p">,</span> <span class="n">inputStream</span><span class="p">:</span><span class="n">readAllBytes</span><span class="p">(),</span> <span class="n">StandardCharsets</span><span class="p">.</span><span class="n">UTF_8</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">results</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">inputString</span><span class="p">)</span>

    <span class="c1">-- Only write to CAS if the results are not nil</span>
    <span class="k">if</span> <span class="n">results</span><span class="p">[</span><span class="s2">"modification_meta"</span><span class="p">]</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="ow">and</span> <span class="n">results</span><span class="p">[</span><span class="s2">"meta"</span><span class="p">]</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="ow">and</span> <span class="n">results</span><span class="p">[</span><span class="s2">"consistency"</span><span class="p">]</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="k">then</span>
        <span class="c1">-- Model information</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"GetInfo"</span><span class="p">)</span>
        <span class="kd">local</span> <span class="n">source</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">"model_source"</span><span class="p">]</span>
        <span class="kd">local</span> <span class="n">model_version</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">"model_version"</span><span class="p">]</span>
        <span class="kd">local</span> <span class="n">model_name</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">"model_name"</span><span class="p">]</span>
        <span class="kd">local</span> <span class="n">model_lang</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">"model_lang"</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"meta"</span><span class="p">)</span>
        <span class="c1">-- Modification meta information</span>
        <span class="kd">local</span> <span class="n">modification_meta</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">"modification_meta"</span><span class="p">]</span>
        <span class="kd">local</span> <span class="n">modification_anno</span> <span class="o">=</span> <span class="n">luajava</span><span class="p">.</span><span class="n">newInstance</span><span class="p">(</span><span class="s2">"org.texttechnologylab.annotation.DocumentModification"</span><span class="p">,</span> <span class="n">inputCas</span><span class="p">)</span>
        <span class="n">modification_anno</span><span class="p">:</span><span class="n">setUser</span><span class="p">(</span><span class="n">modification_meta</span><span class="p">[</span><span class="s2">"user"</span><span class="p">])</span>
        <span class="n">modification_anno</span><span class="p">:</span><span class="n">setTimestamp</span><span class="p">(</span><span class="n">modification_meta</span><span class="p">[</span><span class="s2">"timestamp"</span><span class="p">])</span>
        <span class="n">modification_anno</span><span class="p">:</span><span class="n">setComment</span><span class="p">(</span><span class="n">modification_meta</span><span class="p">[</span><span class="s2">"comment"</span><span class="p">])</span>
        <span class="c1">-- write the information into CAS document</span>
        <span class="n">modification_anno</span><span class="p">:</span><span class="n">addToIndexes</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">"setMetaData"</span><span class="p">)</span>
        <span class="c1">-- Define the model information for the meta data</span>
        <span class="kd">local</span> <span class="n">model_meta</span> <span class="o">=</span> <span class="n">luajava</span><span class="p">.</span><span class="n">newInstance</span><span class="p">(</span><span class="s2">"org.texttechnologylab.annotation.model.MetaData"</span><span class="p">,</span> <span class="n">inputCas</span><span class="p">)</span>
        <span class="n">model_meta</span><span class="p">:</span><span class="n">setModelVersion</span><span class="p">(</span><span class="n">model_version</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">model_version</span><span class="p">)</span>
        <span class="n">model_meta</span><span class="p">:</span><span class="n">setModelName</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
        <span class="n">model_meta</span><span class="p">:</span><span class="n">setSource</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="n">model_meta</span><span class="p">:</span><span class="n">setLang</span><span class="p">(</span><span class="n">model_lang</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">model_lang</span><span class="p">)</span>
        <span class="n">model_meta</span><span class="p">:</span><span class="n">addToIndexes</span><span class="p">()</span>

        <span class="kd">local</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">"meta"</span><span class="p">]</span>
        <span class="c1">-- Get the begin and end positions of the claims and facts</span>
        <span class="kd">local</span> <span class="n">begin_claims</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">"begin_claims"</span><span class="p">]</span>
        <span class="kd">local</span> <span class="n">end_claims</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">"end_claims"</span><span class="p">]</span>
        <span class="kd">local</span> <span class="n">begin_facts</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">"begin_facts"</span><span class="p">]</span>
        <span class="kd">local</span> <span class="n">end_facts</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">"end_facts"</span><span class="p">]</span>
        <span class="kd">local</span> <span class="n">consistency</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">"consistency"</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">index_i</span><span class="p">,</span> <span class="n">cons</span> <span class="k">in</span> <span class="nb">ipairs</span><span class="p">(</span><span class="n">consistency</span><span class="p">)</span> <span class="k">do</span>
            <span class="kd">local</span> <span class="n">begin_claim_i</span> <span class="o">=</span> <span class="n">begin_claims</span><span class="p">[</span><span class="n">index_i</span><span class="p">]</span>
            <span class="kd">local</span> <span class="n">end_claim_i</span> <span class="o">=</span> <span class="n">end_claims</span><span class="p">[</span><span class="n">index_i</span><span class="p">]</span>
            <span class="kd">local</span> <span class="n">begin_fact_i</span> <span class="o">=</span> <span class="n">begin_facts</span><span class="p">[</span><span class="n">index_i</span><span class="p">]</span>
            <span class="kd">local</span> <span class="n">end_fact_i</span> <span class="o">=</span> <span class="n">end_facts</span><span class="p">[</span><span class="n">index_i</span><span class="p">]</span>
            <span class="c1">-- Get the claim and fact from the CAS</span>
            <span class="kd">local</span> <span class="n">claim_i</span> <span class="o">=</span> <span class="n">util</span><span class="p">:</span><span class="n">selectAt</span><span class="p">(</span><span class="n">inputCas</span><span class="p">,</span> <span class="n">claims</span><span class="p">,</span> <span class="n">begin_claim_i</span><span class="p">,</span> <span class="n">end_claim_i</span><span class="p">):</span><span class="n">iterator</span><span class="p">():</span><span class="nb">next</span><span class="p">()</span>
            <span class="kd">local</span> <span class="n">fact_i</span>  <span class="o">=</span> <span class="n">util</span><span class="p">:</span><span class="n">selectAt</span><span class="p">(</span><span class="n">inputCas</span><span class="p">,</span> <span class="n">facts</span><span class="p">,</span> <span class="n">begin_fact_i</span><span class="p">,</span> <span class="n">end_fact_i</span><span class="p">):</span><span class="n">iterator</span><span class="p">():</span><span class="nb">next</span><span class="p">()</span>
            <span class="c1">-- Create the fact-checking annotation</span>
            <span class="kd">local</span> <span class="n">factcheck_i</span> <span class="o">=</span> <span class="n">luajava</span><span class="p">.</span><span class="n">newInstance</span><span class="p">(</span><span class="s2">"org.texttechnologylab.annotation.FactChecking"</span><span class="p">,</span> <span class="n">inputCas</span><span class="p">)</span>
            <span class="c1">-- Set the claim, fact, consistency and model information</span>
            <span class="n">factcheck_i</span><span class="p">:</span><span class="n">setClaim</span><span class="p">(</span><span class="n">claim_i</span><span class="p">)</span>
            <span class="n">factcheck_i</span><span class="p">:</span><span class="n">setFact</span><span class="p">(</span><span class="n">fact_i</span><span class="p">)</span>
            <span class="n">factcheck_i</span><span class="p">:</span><span class="n">setConsistency</span><span class="p">(</span><span class="n">cons</span><span class="p">)</span>
            <span class="n">factcheck_i</span><span class="p">:</span><span class="n">setModel</span><span class="p">(</span><span class="n">model_meta</span><span class="p">)</span>
            <span class="n">factcheck_i</span><span class="p">:</span><span class="n">addToIndexes</span><span class="p">()</span>
        <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

        </section>

        <aside id="sidebar">
          <img src="/assets/images/DUUI_Logo.png" width="100%">
          
          <a href="https://github.com/texttechnologylab/DockerUnifiedUIMAInterface" target="_blank" class="button"><small>View project on</small> GitHub</a>
          
          
          <a href="https://github.com/texttechnologylab" target="_blank" class="button"><small style="margin-top: -12px;">Powerd by</small>
          <img src="/assets/images/ttlab.png" width="80%;"></a>
<!--          <p class="repo-owner"><a href="https://github.com/texttechnologylab/DockerUnifiedUIMAInterface">Docker Unified UIMA Interface</a> is maintained by <a href="https://github.com/texttechnologylab">Texttechnology Lab</a>.</p>-->
          

          <p>This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</p>
        </aside>
      </div>
    </div>

  </body>
</html>
