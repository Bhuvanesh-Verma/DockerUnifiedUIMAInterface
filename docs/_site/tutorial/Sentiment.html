<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="/assets/css/style.css?v=" media="screen" type="text/css">
    <link rel="stylesheet" href="/assets/css/print.css" media="print" type="text/css">

    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <![endif]-->

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Docker Unified UIMA Interface (DUUI) | A framework at the dawn of a new era for NLP processing</title>
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="Docker Unified UIMA Interface (DUUI)" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A framework at the dawn of a new era for NLP processing" />
<meta property="og:description" content="A framework at the dawn of a new era for NLP processing" />
<link rel="canonical" href="http://localhost:4000/tutorial/Sentiment.html" />
<meta property="og:url" content="http://localhost:4000/tutorial/Sentiment.html" />
<meta property="og:site_name" content="Docker Unified UIMA Interface (DUUI)" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Docker Unified UIMA Interface (DUUI)" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"A framework at the dawn of a new era for NLP processing","headline":"Docker Unified UIMA Interface (DUUI)","url":"http://localhost:4000/tutorial/Sentiment.html"}</script>
<!-- End Jekyll SEO tag -->


    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" -->

<!-- end custom head snippets -->

  </head>

  <body>
    <header>
      <div class="inner">
        <a href="http://localhost:4000/">
          <h1>Docker Unified UIMA Interface (DUUI)</h1>
        </a>
        <h2>A framework at the dawn of a new era for NLP processing</h2>

      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
          <h1 id="integration-of-a-sentiment-tool-in-duui-step-by-step">Integration of a Sentiment Tool in DUUI Step by Step</h1>

<p>In this section, we will explain how to integrate a sentiment analysis tool into DUUI step by step.
The Integration in this example is developed using the  Python programming language, because the underlying sentiment tool is also implemented in Python.
We use the Hugging Face implementation of the model <a href="https://huggingface.co/cardiffnlp/twitter-xlm-roberta-base-sentiment">cardiffnlp/twitter-xlm-roberta-base-sentiment</a> (see <a href="https://aclanthology.org/2022.lrec-1.27/">Barbieri et al. 2022</a>) as the tool, which allows us to predict a sentiment polarity label (i.e. Positive, Neutral, or Negative) and a confidence value for text in 8 languages.
The full example code can be found in the <a href="https://github.com/texttechnologylab/duui-uima/tree/main/duui-transformers-sentiment-example">GitHub repository</a>.</p>

<h2 id="typeystem-for-sentiment-analysis">Typeystem for Sentiment Analysis</h2>
<p>The first step when integrating a tool into DUUI is to define the typesystem required, i.e. what types (e.g. SentimentCategory) are needed to process the input and store the output of the tool. If the needed types are not already defined in the typesystem repository (<a href="https://github.com/texttechnologylab/UIMATypeSystem">UIMATypeSystem</a>) by the Text Technology Lab, they need to be created and added.
The typesystem for the sentiment analysis tool is shown in the following XML snippet, where a <code class="language-plaintext highlighter-rouge">Sentiment</code> type (full name <code class="language-plaintext highlighter-rouge">org.hucompute.textimager.uima.type.Sentiment</code>) is defined with two features: <code class="language-plaintext highlighter-rouge">sentiment</code> (a floating number, but by definition we use a value of <code class="language-plaintext highlighter-rouge">-1</code>, <code class="language-plaintext highlighter-rouge">0</code>, or <code class="language-plaintext highlighter-rouge">+1</code>, depending on the polarity) and <code class="language-plaintext highlighter-rouge">subjectivity</code>. Note that by using the super class <code class="language-plaintext highlighter-rouge">uima.tcas.Annotation</code>, the <code class="language-plaintext highlighter-rouge">Sentiment</code> type can be used to annotate text spans in the CAS document by providing a <code class="language-plaintext highlighter-rouge">begin</code> end <code class="language-plaintext highlighter-rouge">end</code> index.</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;typeSystemDescription</span> <span class="na">xmlns=</span><span class="s">"http://uima.apache.org/resourceSpecifier"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;types&gt;</span>
        <span class="nt">&lt;typeDescription&gt;</span>
            <span class="nt">&lt;name&gt;</span>org.hucompute.textimager.uima.type.Sentiment<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;description/&gt;</span>
            <span class="nt">&lt;supertypeName&gt;</span>uima.tcas.Annotation<span class="nt">&lt;/supertypeName&gt;</span>
            <span class="nt">&lt;features&gt;</span>
                <span class="nt">&lt;featureDescription&gt;</span>
                    <span class="nt">&lt;name&gt;</span>sentiment<span class="nt">&lt;/name&gt;</span>
                    <span class="nt">&lt;description/&gt;</span>
                    <span class="nt">&lt;rangeTypeName&gt;</span>uima.cas.Double<span class="nt">&lt;/rangeTypeName&gt;</span>
                <span class="nt">&lt;/featureDescription&gt;</span>
                <span class="nt">&lt;featureDescription&gt;</span>
                    <span class="nt">&lt;name&gt;</span>subjectivity<span class="nt">&lt;/name&gt;</span>
                    <span class="nt">&lt;description/&gt;</span>
                    <span class="nt">&lt;rangeTypeName&gt;</span>uima.cas.Double<span class="nt">&lt;/rangeTypeName&gt;</span>
                <span class="nt">&lt;/featureDescription&gt;</span>
            <span class="nt">&lt;/features&gt;</span>
        <span class="nt">&lt;/typeDescription&gt;</span>
    <span class="nt">&lt;/types&gt;</span>
<span class="nt">&lt;/typeSystemDescription&gt;</span>
</code></pre></div></div>

<h2 id="sentiment-integration-in-duui-with-python">Sentiment Integration in DUUI with Python</h2>
<p>After defining the typesystem, we can integrate the sentiment analysis tool into DUUI.
Install the needed required packages (as listed in the <code class="language-plaintext highlighter-rouge">requirements.txt</code> file) with the following command, after creating a virtual environment (e.g. via virtualenv or (Mini)Conda) using Python 3.8 in IntelliJ (recommended).<br />
<code class="language-plaintext highlighter-rouge">pip install -r requirements.txt</code><br />
The following code shows how to integrate the sentiment tool into DUUI and can be found in the file <code class="language-plaintext highlighter-rouge">duui-transformers-sentiment-example/src/main/python/duui_transformers_sentiment.py</code> in the repository. Please refer to the comments for further details.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">logging</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="n">cassis</span> <span class="kn">import</span> <span class="n">load_typesystem</span>
<span class="kn">from</span> <span class="n">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="n">fastapi.responses</span> <span class="kn">import</span> <span class="n">PlainTextResponse</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseSettings</span><span class="p">,</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="n">transformers</span> <span class="kn">import</span> <span class="n">pipeline</span>


<span class="k">class</span> <span class="nc">Settings</span><span class="p">(</span><span class="n">BaseSettings</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Tool settings, this is used to configure the tool using environment variables given to Docker
    </span><span class="sh">"""</span>

    <span class="c1"># Name of annotator
</span>    <span class="n">annotator_name</span><span class="p">:</span> <span class="nb">str</span>

    <span class="c1"># Version of annotator
</span>    <span class="n">annotator_version</span><span class="p">:</span> <span class="nb">str</span>

    <span class="c1"># Log level
</span>    <span class="n">log_level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

    <span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        Extra settings configuration
        </span><span class="sh">"""</span>

        <span class="c1"># Prefix for environment variables, note that env vars have to be provided fully uppercase
</span>        <span class="n">env_prefix</span> <span class="o">=</span> <span class="sh">'</span><span class="s">ttlab_duui_transformers_sentiment_example_</span><span class="sh">'</span>


<span class="k">class</span> <span class="nc">DUUIRequest</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    This is the request sent by DUUI to this tool, i.e. the input data. This is beeing created by the Lua transformation and is thus specific to the tool.
    </span><span class="sh">"""</span>

    <span class="c1"># The full text to be analyzed
</span>    <span class="n">text</span><span class="p">:</span> <span class="nb">str</span>

    <span class="c1"># The language of the text
</span>    <span class="n">lang</span><span class="p">:</span> <span class="nb">str</span>

    <span class="c1"># The length of the document
</span>    <span class="n">doc_len</span><span class="p">:</span> <span class="nb">int</span>


<span class="k">class</span> <span class="nc">DUUIResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    This is the response of this tool back to DUUI, i.e. the output data. This is beeing transformed back to UIMA/CAS by Lua and is thus specific to the tool.
    </span><span class="sh">"""</span>

    <span class="c1"># The sentiment label, i.e. -1, 0 or 1 showing the polarity of the sentiment
</span>    <span class="n">sentiment_label</span><span class="p">:</span> <span class="nb">int</span>

    <span class="c1"># The sentiment score, i.e. the confidence of the sentiment
</span>    <span class="n">sentiment_score</span><span class="p">:</span> <span class="nb">float</span>


<span class="c1"># Initialize settings, this will pull the settings from the environment
</span><span class="n">settings</span> <span class="o">=</span> <span class="nc">Settings</span><span class="p">()</span>

<span class="c1"># Set up logging using the log level provided in the settings
</span><span class="n">logging</span><span class="p">.</span><span class="nf">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">log_level</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="nf">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">TTLab DUUI Transformers Sentiment Example</span><span class="sh">"</span><span class="p">)</span>
<span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Name: %s</span><span class="sh">"</span><span class="p">,</span> <span class="n">settings</span><span class="p">.</span><span class="n">annotator_name</span><span class="p">)</span>
<span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Version: %s</span><span class="sh">"</span><span class="p">,</span> <span class="n">settings</span><span class="p">.</span><span class="n">annotator_version</span><span class="p">)</span>

<span class="c1"># Load the type system
</span><span class="n">typesystem_filename</span> <span class="o">=</span> <span class="sh">'</span><span class="s">src/main/resources/TypeSystemSentiment.xml</span><span class="sh">'</span>
<span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Loading typesystem from </span><span class="se">\"</span><span class="s">%s</span><span class="se">\"</span><span class="sh">"</span><span class="p">,</span> <span class="n">typesystem_filename</span><span class="p">)</span>
<span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">typesystem_filename</span><span class="p">,</span> <span class="sh">'</span><span class="s">rb</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">typesystem</span> <span class="o">=</span> <span class="nf">load_typesystem</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sh">"</span><span class="s">Base typesystem:</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="n">typesystem</span><span class="p">.</span><span class="nf">to_xml</span><span class="p">())</span>

<span class="c1"># Load the Lua communication layer
</span><span class="n">lua_communication_script_filename</span> <span class="o">=</span> <span class="sh">"</span><span class="s">src/main/lua/duui_transformers_sentiment.lua</span><span class="sh">"</span>
<span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Loading Lua communication script from </span><span class="se">\"</span><span class="s">%s</span><span class="se">\"</span><span class="sh">"</span><span class="p">,</span> <span class="n">lua_communication_script_filename</span><span class="p">)</span>
<span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">lua_communication_script_filename</span><span class="p">,</span> <span class="sh">'</span><span class="s">rb</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">lua_communication_script</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sh">"</span><span class="s">Lua communication script:</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="n">lua_communication_script</span><span class="p">)</span>

<span class="c1"># Load the model
</span><span class="n">model</span> <span class="o">=</span> <span class="nf">pipeline</span><span class="p">(</span>
    <span class="sh">"</span><span class="s">sentiment-analysis</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">cardiffnlp/twitter-xlm-roberta-base-sentiment</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="o">=</span><span class="sh">"</span><span class="s">cardiffnlp/twitter-xlm-roberta-base-sentiment</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">revision</span><span class="o">=</span><span class="sh">"</span><span class="s">f3e34b6c30bf27b6649f72eca85d0bbe79df1e55</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">top_k</span><span class="o">=</span><span class="mi">3</span>
<span class="p">)</span>

<span class="c1"># Start the FastAPI app and provide some meta information, these are accessible via the /docs endpoint
</span><span class="n">app</span> <span class="o">=</span> <span class="nc">FastAPI</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">annotator_name</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Transformers-based sentiment analysis for TTLab DUUI</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">version</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">annotator_version</span><span class="p">,</span>
    <span class="n">terms_of_service</span><span class="o">=</span><span class="sh">"</span><span class="s">https://www.texttechnologylab.org/legal_notice/</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">contact</span><span class="o">=</span><span class="p">{</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">TTLab Team</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">https://texttechnologylab.org</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">email</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">baumartz@em.uni-frankfurt.de</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">license_info</span><span class="o">=</span><span class="p">{</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">AGPL</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">http://www.gnu.org/licenses/agpl-3.0.en.html</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span>


<span class="nd">@app.get</span><span class="p">(</span><span class="sh">"</span><span class="s">/v1/communication_layer</span><span class="sh">"</span><span class="p">,</span> <span class="n">response_class</span><span class="o">=</span><span class="n">PlainTextResponse</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_communication_layer</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    This is a DUUI API endpoint that needs to be present in every tool.
    :return: The Lua communication script
    </span><span class="sh">"""</span>
    <span class="k">return</span> <span class="n">lua_communication_script</span>


<span class="nd">@app.get</span><span class="p">(</span><span class="sh">"</span><span class="s">/v1/typesystem</span><span class="sh">"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_typesystem</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    This is a DUUI API endpoint that needs to be present in every tool.
    :return: The typesystem as XML, this should include all types the tool can produce
    </span><span class="sh">"""</span>
    <span class="n">xml</span> <span class="o">=</span> <span class="n">typesystem</span><span class="p">.</span><span class="nf">to_xml</span><span class="p">()</span>
    <span class="n">xml_content</span> <span class="o">=</span> <span class="n">xml</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">return</span> <span class="nc">Response</span><span class="p">(</span>
        <span class="n">content</span><span class="o">=</span><span class="n">xml_content</span><span class="p">,</span>
        <span class="n">media_type</span><span class="o">=</span><span class="sh">"</span><span class="s">application/xml</span><span class="sh">"</span>
    <span class="p">)</span>


<span class="nd">@app.post</span><span class="p">(</span><span class="sh">"</span><span class="s">/v1/process</span><span class="sh">"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">post_process</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">DUUIRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DUUIResponse</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    This is a DUUI API endpoint that needs to be present in every tool. This is the main processing endpoint, that will be called for each document. It receives the data produced by the Lua transformation script and returns the processed data, that will then be transformed back by Lua. Note that the data handling is specific for each tool.
    :param request: The request object containing the data transformed by Lua.
    :return: The processed data.
    </span><span class="sh">"""</span>
    <span class="n">sentiment_label</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">sentiment_score</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sh">"</span><span class="s">Received:</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="c1"># Run the sentiment analysis
</span>        <span class="n">result</span> <span class="o">=</span> <span class="nf">model</span><span class="p">(</span>
            <span class="n">request</span><span class="p">.</span><span class="n">text</span><span class="p">,</span>
            <span class="n">truncation</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">padding</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">max_length</span><span class="o">=</span><span class="mi">512</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="c1"># get the top sentiment label, i.e. "Positive"
</span>        <span class="n">sentiment_score</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">score</span><span class="sh">"</span><span class="p">]</span>

        <span class="c1"># map the label to the sentiment type, i.e. to -1, 0 or 1
</span>        <span class="n">label</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">label</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">sentiment_mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">Positive</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">Neutral</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">Negative</span><span class="sh">"</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span>
        <span class="p">}</span>
        <span class="n">sentiment_label</span> <span class="o">=</span> <span class="n">sentiment_mapping</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>

    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">exception</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>

    <span class="c1"># Return the response back to DUUI where it will be transformed using Lua
</span>    <span class="k">return</span> <span class="nc">DUUIResponse</span><span class="p">(</span>
        <span class="n">sentiment_label</span><span class="o">=</span><span class="n">sentiment_label</span><span class="p">,</span>
        <span class="n">sentiment_score</span><span class="o">=</span><span class="n">sentiment_score</span>
    <span class="p">)</span>
</code></pre></div></div>

<h2 id="lua">Lua</h2>
<p>The Lua script is used to transform the CAS document, which contains all document data (text and annotations), to a format that is supported by the tool. This means, it first extracts the needed information from the CAS object and generates a JSON-based request that is sent to the tool by DUUI. Secondly, it transforms the response of the tool, which is a JSON object, back to the CAS object. The Lua script can be found in the file <code class="language-plaintext highlighter-rouge">duui-transformers-sentiment-example/src/main/lua/duui_transformers_sentiment.lua</code> in the repository. Please refer to the comments for further details.</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">StandardCharsets</span> <span class="o">=</span> <span class="n">luajava</span><span class="p">.</span><span class="n">bindClass</span><span class="p">(</span><span class="s2">"java.nio.charset.StandardCharsets"</span><span class="p">)</span>
<span class="n">Class</span> <span class="o">=</span> <span class="n">luajava</span><span class="p">.</span><span class="n">bindClass</span><span class="p">(</span><span class="s2">"java.lang.Class"</span><span class="p">)</span>
<span class="n">JCasUtil</span> <span class="o">=</span> <span class="n">luajava</span><span class="p">.</span><span class="n">bindClass</span><span class="p">(</span><span class="s2">"org.apache.uima.fit.util.JCasUtil"</span><span class="p">)</span>
<span class="n">SentimentUtils</span> <span class="o">=</span> <span class="n">luajava</span><span class="p">.</span><span class="n">bindClass</span><span class="p">(</span><span class="s2">"org.texttechnologylab.DockerUnifiedUIMAInterface.lua.DUUILuaUtils"</span><span class="p">)</span>

<span class="k">function</span> <span class="nf">serialize</span><span class="p">(</span><span class="n">inputCas</span><span class="p">,</span> <span class="n">outputStream</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>
    <span class="c1">-- Get document text, language and size from CAS</span>
    <span class="kd">local</span> <span class="n">doc_lang</span> <span class="o">=</span> <span class="n">inputCas</span><span class="p">:</span><span class="n">getDocumentLanguage</span><span class="p">()</span>
    <span class="kd">local</span> <span class="n">doc_text</span> <span class="o">=</span> <span class="n">inputCas</span><span class="p">:</span><span class="n">getDocumentText</span><span class="p">()</span>
    <span class="kd">local</span> <span class="n">doc_len</span> <span class="o">=</span> <span class="n">SentimentUtils</span><span class="p">:</span><span class="n">getDocumentTextLength</span><span class="p">(</span><span class="n">inputCas</span><span class="p">)</span>

    <span class="c1">-- Encode as JSON and write to the output stream, this is then sent to the tool</span>
    <span class="n">outputStream</span><span class="p">:</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="n">encode</span><span class="p">({</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">doc_text</span><span class="p">,</span>
        <span class="n">lang</span> <span class="o">=</span> <span class="n">doc_lang</span><span class="p">,</span>
        <span class="n">doc_len</span> <span class="o">=</span> <span class="n">doc_len</span><span class="p">,</span>
    <span class="p">}))</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">deserialize</span><span class="p">(</span><span class="n">inputCas</span><span class="p">,</span> <span class="n">inputStream</span><span class="p">)</span>
    <span class="c1">-- Read the JSON from the input stream and decode it</span>
    <span class="kd">local</span> <span class="n">inputString</span> <span class="o">=</span> <span class="n">luajava</span><span class="p">.</span><span class="n">newInstance</span><span class="p">(</span><span class="s2">"java.lang.String"</span><span class="p">,</span> <span class="n">inputStream</span><span class="p">:</span><span class="n">readAllBytes</span><span class="p">(),</span> <span class="n">StandardCharsets</span><span class="p">.</span><span class="n">UTF_8</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">results</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">inputString</span><span class="p">)</span>

    <span class="c1">-- Check if the JSON contains the expected keys...</span>
    <span class="k">if</span> <span class="n">results</span><span class="p">[</span><span class="s2">"sentiment_label"</span><span class="p">]</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="ow">and</span> <span class="n">results</span><span class="p">[</span><span class="s2">"sentiment_score"</span><span class="p">]</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="k">then</span>
        <span class="c1">-- Create the sentiment metadata</span>
        <span class="kd">local</span> <span class="n">sentiment_anno</span> <span class="o">=</span> <span class="n">luajava</span><span class="p">.</span><span class="n">newInstance</span><span class="p">(</span><span class="s2">"org.hucompute.textimager.uima.type.Sentiment"</span><span class="p">,</span> <span class="n">inputCas</span><span class="p">)</span>
        <span class="n">sentiment_anno</span><span class="p">:</span><span class="n">setBegin</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">sentiment_anno</span><span class="p">:</span><span class="n">setEnd</span><span class="p">(</span><span class="n">SentimentUtils</span><span class="p">:</span><span class="n">getDocumentTextLength</span><span class="p">(</span><span class="n">inputCas</span><span class="p">))</span>
        <span class="n">sentiment_anno</span><span class="p">:</span><span class="n">setSentiment</span><span class="p">(</span><span class="n">sentiment_label</span><span class="p">)</span>
        <span class="n">sentiment_anno</span><span class="p">:</span><span class="n">addToIndexes</span><span class="p">()</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="docker">Docker</h2>

<p>The Dockerfile for this example can be found in <code class="language-plaintext highlighter-rouge">duui-transformers-sentiment-example/src/main/docker/Dockerfile</code> in the repository. It is used to build a Docker image that can be used to run the tool in a containerized environment. Special care should be taken that this image is as static as possible to enable reproducibility, i.e. it should contain all needed code and data (in this case, the actual model file is preloaded pinned to a specific version and Hugging Face is setup to not check online for model information or updates).</p>
<div class="language-docker highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> python:3.8</span>

<span class="k">WORKDIR</span><span class="s"> /usr/src/app</span>

<span class="c"># This port is specified by the DUUI API</span>
<span class="k">EXPOSE</span><span class="s"> 9714</span>

<span class="c"># Install dependencies</span>
<span class="k">RUN </span>pip <span class="nb">install </span>setuptools wheel
<span class="k">COPY</span><span class="s"> ./requirements.txt ./requirements.txt</span>
<span class="k">RUN </span>pip <span class="nb">install</span> <span class="nt">--no-deps</span> <span class="nt">-r</span> requirements.txt

<span class="c"># Preload Models during Docker build</span>
<span class="k">RUN </span>python3 <span class="nt">-c</span> <span class="s1">'from transformers import pipeline; pipeline("sentiment-analysis", model="cardiffnlp/twitter-xlm-roberta-base-sentiment", tokenizer="cardiffnlp/twitter-xlm-roberta-base-sentiment", revision="f3e34b6c30bf27b6649f72eca85d0bbe79df1e55")'</span>

<span class="c"># Log level</span>
<span class="k">ARG</span><span class="s"> TTLAB_DUUI_TRANSFORMERS_SENTIMENT_EXAMPLE_LOG_LEVEL="DEBUG"</span>
<span class="k">ENV</span><span class="s"> TTLAB_DUUI_TRANSFORMERS_SENTIMENT_EXAMPLE_LOG_LEVEL=$TTLAB_DUUI_TRANSFORMERS_SENTIMENT_EXAMPLE_LOG_LEVEL</span>

<span class="c"># Meta data</span>
<span class="k">ARG</span><span class="s"> TTLAB_DUUI_TRANSFORMERS_SENTIMENT_EXAMPLE_ANNOTATOR_NAME="duui-transformers-sentiment-example"</span>
<span class="k">ENV</span><span class="s"> TTLAB_DUUI_TRANSFORMERS_SENTIMENT_EXAMPLE_ANNOTATOR_NAME=$TTLAB_DUUI_TRANSFORMERS_SENTIMENT_EXAMPLE_ANNOTATOR_NAME</span>
<span class="k">ARG</span><span class="s"> TTLAB_DUUI_TRANSFORMERS_SENTIMENT_EXAMPLE_ANNOTATOR_VERSION="dev"</span>
<span class="k">ENV</span><span class="s"> TTLAB_DUUI_TRANSFORMERS_SENTIMENT_EXAMPLE_ANNOTATOR_VERSION=$TTLAB_DUUI_TRANSFORMERS_SENTIMENT_EXAMPLE_ANNOTATOR_VERSION</span>

<span class="c"># Enable offline mode for Hugging Face</span>
<span class="k">ARG</span><span class="s"> TTLAB_DUUI_TRANSFORMERS_SENTIMENT_EXAMPLE_TRANSFORMERS_OFFLINE=1</span>
<span class="k">ENV</span><span class="s"> TRANSFORMERS_OFFLINE=$TTLAB_DUUI_TRANSFORMERS_SENTIMENT_EXAMPLE_TRANSFORMERS_OFFLINE</span>

<span class="c"># Copy all needed scripts</span>
<span class="k">COPY</span><span class="s"> ./src/main/resources/TypeSystemSentiment.xml ./src/main/resources/TypeSystemSentiment.xml</span>
<span class="k">COPY</span><span class="s"> ./src/main/python/duui_transformers_sentiment.py ./src/main/python/duui_transformers_sentiment.py</span>
<span class="k">COPY</span><span class="s"> ./src/main/lua/duui_transformers_sentiment.lua ./src/main/lua/duui_transformers_sentiment.lua</span>

<span class="c"># Start the Python server</span>
<span class="k">ENTRYPOINT</span><span class="s"> ["uvicorn", "src.main.python.duui_transformers_sentiment:app", "--host", "0.0.0.0", "--port" ,"9714"]</span>
<span class="k">CMD</span><span class="s"> ["--workers", "1"]</span>
</code></pre></div></div>

<p>The Docker image is built using the following command:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
<span class="nb">set</span> <span class="nt">-euo</span> pipefail

<span class="c"># Name and version of the tool</span>
<span class="c"># These are defined here to keep the versions in Python and Docker synchronized</span>
<span class="nb">export </span><span class="nv">TTLAB_DUUI_TRANSFORMERS_SENTIMENT_EXAMPLE_ANNOTATOR_NAME</span><span class="o">=</span>duui-transformers-sentiment-example
<span class="nb">export </span><span class="nv">TTLAB_DUUI_TRANSFORMERS_SENTIMENT_EXAMPLE_ANNOTATOR_VERSION</span><span class="o">=</span>1.0.0

<span class="c"># docker registry to use</span>
<span class="nb">export </span><span class="nv">TTLAB_DUUI_DOCKER_REGISTRY</span><span class="o">=</span><span class="s2">"docker.texttechnologylab.org/"</span>

<span class="c"># Build the Docker image</span>
docker build <span class="se">\</span>
  <span class="nt">--build-arg</span> TTLAB_DUUI_TRANSFORMERS_SENTIMENT_EXAMPLE_ANNOTATOR_NAME <span class="se">\</span>
  <span class="nt">--build-arg</span> TTLAB_DUUI_TRANSFORMERS_SENTIMENT_EXAMPLE_ANNOTATOR_VERSION <span class="se">\</span>
  <span class="nt">-t</span> <span class="k">${</span><span class="nv">TTLAB_DUUI_DOCKER_REGISTRY</span><span class="k">}${</span><span class="nv">TTLAB_DUUI_TRANSFORMERS_SENTIMENT_EXAMPLE_ANNOTATOR_NAME</span><span class="k">}</span>:<span class="k">${</span><span class="nv">TTLAB_DUUI_TRANSFORMERS_SENTIMENT_EXAMPLE_ANNOTATOR_VERSION</span><span class="k">}</span> <span class="se">\</span>
  <span class="nt">-f</span> <span class="s2">"src/main/docker/Dockerfile"</span> <span class="se">\</span>
  <span class="nb">.</span>

<span class="c"># Automatically tag the newest image as "latest"</span>
docker tag <span class="se">\</span>
  <span class="k">${</span><span class="nv">TTLAB_DUUI_DOCKER_REGISTRY</span><span class="k">}${</span><span class="nv">TTLAB_DUUI_TRANSFORMERS_SENTIMENT_EXAMPLE_ANNOTATOR_NAME</span><span class="k">}</span>:<span class="k">${</span><span class="nv">TTLAB_DUUI_TRANSFORMERS_SENTIMENT_EXAMPLE_ANNOTATOR_VERSION</span><span class="k">}</span> <span class="se">\</span>
  <span class="k">${</span><span class="nv">TTLAB_DUUI_DOCKER_REGISTRY</span><span class="k">}${</span><span class="nv">TTLAB_DUUI_TRANSFORMERS_SENTIMENT_EXAMPLE_ANNOTATOR_NAME</span><span class="k">}</span>:latest
</code></pre></div></div>
<p>This automatically builds the Docker image and generates a tag for the latest version. The image can then be pushed to the Text Technology Lab Docker registry.</p>

<p>Finally, see the Java JUnit tests for the sentiment tool in the file <code class="language-plaintext highlighter-rouge">duui-transformers-sentiment-example/src/test/java/org/hucompute/textimager/uima/transformers/sentiment/CardiffnlpTwitterXlmRobertaBaseSentimentTest.java</code> in the repository. The tests are used to check the functionality of the tool and to ensure that it works as expected.</p>

        </section>

        <aside id="sidebar">
          <img src="/assets/images/DUUI_Logo.png" width="100%">
          
          <a href="https://github.com/texttechnologylab/DockerUnifiedUIMAInterface" target="_blank" class="button"><small>View project on</small> GitHub</a>
          
          
          <a href="https://github.com/texttechnologylab" target="_blank" class="button"><small style="margin-top: -12px;">Powerd by</small>
          <img src="/assets/images/ttlab.png" width="80%;"></a>
<!--          <p class="repo-owner"><a href="https://github.com/texttechnologylab/DockerUnifiedUIMAInterface">Docker Unified UIMA Interface</a> is maintained by <a href="https://github.com/texttechnologylab">Texttechnology Lab</a>.</p>-->
          

          <p>This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</p>
        </aside>
      </div>
    </div>

  </body>
</html>
