<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="/assets/css/style.css?v=" media="screen" type="text/css">
    <link rel="stylesheet" href="/assets/css/print.css" media="print" type="text/css">

    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <![endif]-->

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Docker Unified UIMA Interface (DUUI) | A framework at the dawn of a new era for NLP processing</title>
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="Docker Unified UIMA Interface (DUUI)" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A framework at the dawn of a new era for NLP processing" />
<meta property="og:description" content="A framework at the dawn of a new era for NLP processing" />
<link rel="canonical" href="http://localhost:4000/tutorial/HateCheck.html" />
<meta property="og:url" content="http://localhost:4000/tutorial/HateCheck.html" />
<meta property="og:site_name" content="Docker Unified UIMA Interface (DUUI)" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Docker Unified UIMA Interface (DUUI)" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"A framework at the dawn of a new era for NLP processing","headline":"Docker Unified UIMA Interface (DUUI)","url":"http://localhost:4000/tutorial/HateCheck.html"}</script>
<!-- End Jekyll SEO tag -->


    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" -->

<!-- end custom head snippets -->

  </head>

  <body>
    <header>
      <div class="inner">
        <a href="http://localhost:4000/">
          <h1>Docker Unified UIMA Interface (DUUI)</h1>
        </a>
        <h2>A framework at the dawn of a new era for NLP processing</h2>

      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
          <h1 id="integration-of-hatecheck-into-the-duui-pipeline">Integration of HateCheck into the DUUI pipeline</h1>
<p>The Integration for this example is with python, because the HateCheck tool is implemented in python.
In this section, we will explain how to integrate a HateCheck tool into the DUUI pipeline step by step.
The HateCheck module is a part of the DUUI pipeline that is responsible for calculating the hate speech score of a given text.</p>

<h2 id="typeystem-for-hatecheck">Typeystem for HateCheck</h2>
<p>The first step is to define the typesystem for the HatCheck tool, if the needed types are not already defined in the typesystem repository (<a href="https://github.com/texttechnologylab/UIMATypeSystem">UIMATypeSystem</a>).
The typesystem for the HateCheck tool is defined in the following XML format:</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;typeSystemDescription</span> <span class="na">xmlns=</span><span class="s">"http://uima.apache.org/resourceSpecifier"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;name&gt;</span>TypeSystemFactChecking<span class="nt">&lt;/name&gt;</span>

    <span class="nt">&lt;description/&gt;</span>

    <span class="nt">&lt;version&gt;</span>1.0<span class="nt">&lt;/version&gt;</span>

    <span class="nt">&lt;vendor/&gt;</span>

    <span class="c">&lt;!-- Import the needed types --&gt;</span>
    <span class="nt">&lt;imports&gt;</span>
        <span class="nt">&lt;import</span> <span class="na">name=</span><span class="s">"desc.type.TextTechnologyAnnotation"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;import</span> <span class="na">name=</span><span class="s">"desc.type.TypeSystemModelMeta"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/imports&gt;</span>
    <span class="nt">&lt;types&gt;</span>

        <span class="nt">&lt;typeDescription&gt;</span>
            <span class="c">&lt;!-- Define the type for HateCheck --&gt;</span>
            <span class="nt">&lt;name&gt;</span>org.texttechnologylab.annotation.Hate<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;description&gt;</span>
                Hate Output
            <span class="nt">&lt;/description&gt;</span>
            <span class="c">&lt;!-- The supertype of HateCheck, get every function of Annotation --&gt;</span>
            <span class="nt">&lt;supertypeName&gt;</span>uima.tcas.Annotation<span class="nt">&lt;/supertypeName&gt;</span>
            <span class="nt">&lt;features&gt;</span>

                <span class="nt">&lt;featureDescription&gt;</span>
                    <span class="c">&lt;!-- Probability of Hate --&gt;</span>
                    <span class="nt">&lt;name&gt;</span>Hate<span class="nt">&lt;/name&gt;</span>
                    <span class="nt">&lt;description&gt;</span>Probability of Hate<span class="nt">&lt;/description&gt;</span>
                    <span class="nt">&lt;rangeTypeName&gt;</span>uima.cas.Double<span class="nt">&lt;/rangeTypeName&gt;</span>
                <span class="nt">&lt;/featureDescription&gt;</span>

                <span class="nt">&lt;featureDescription&gt;</span>
                    <span class="c">&lt;!-- Probability of not Hate --&gt;</span>
                    <span class="nt">&lt;name&gt;</span>NonHate<span class="nt">&lt;/name&gt;</span>
                    <span class="nt">&lt;description&gt;</span>Probability of not Hate<span class="nt">&lt;/description&gt;</span>
                    <span class="nt">&lt;rangeTypeName&gt;</span>uima.cas.Double<span class="nt">&lt;/rangeTypeName&gt;</span>
                <span class="nt">&lt;/featureDescription&gt;</span>

                <span class="nt">&lt;featureDescription&gt;</span>
                    <span class="c">&lt;!-- Used model for the annotation --&gt;</span>
                    <span class="nt">&lt;name&gt;</span>model<span class="nt">&lt;/name&gt;</span>
                    <span class="nt">&lt;description/&gt;</span>
                    <span class="nt">&lt;rangeTypeName&gt;</span>org.texttechnologylab.annotation.model.MetaData<span class="nt">&lt;/rangeTypeName&gt;</span>
                <span class="nt">&lt;/featureDescription&gt;</span>
            <span class="nt">&lt;/features&gt;</span>
        <span class="nt">&lt;/typeDescription&gt;</span>
    <span class="nt">&lt;/types&gt;</span>
<span class="nt">&lt;/typeSystemDescription&gt;</span>
</code></pre></div></div>

<h2 id="hatecheck-integration-in-the-duui-pipeline-with-python">HateCheck Integration in the DUUI Pipeline with Python</h2>
<p>After defining the typesystem, we can integrate the HateCheck tool into the DUUI pipeline.
The HateCheck tool is implemented in python.
Install the needed packages with the following command, after creating a virtual environment(via conda) with python 3.8 in IntelliJ.<br />
<code class="language-plaintext highlighter-rouge">pip install -r requirements.txt</code><br />
The following code snippet shows how to integrate the HateCheck tool into the DUUI pipeline `duui-HateCheckTest/src/main/python/duui_hate.py.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="n">pydantic_settings</span> <span class="kn">import</span> <span class="n">BaseSettings</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">import</span> <span class="n">logging</span>
<span class="kn">from</span> <span class="n">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="n">cassis</span> <span class="kn">import</span> <span class="n">load_typesystem</span>
<span class="kn">import</span> <span class="n">torch</span>
<span class="kn">from</span> <span class="n">functools</span> <span class="kn">import</span> <span class="n">lru_cache</span>
<span class="c1"># Import the HateCheck tool
</span><span class="kn">from</span> <span class="n">hatechecker</span> <span class="kn">import</span> <span class="n">HateCheck</span>
<span class="kn">from</span> <span class="n">threading</span> <span class="kn">import</span> <span class="n">Lock</span>
<span class="kn">from</span> <span class="n">starlette.responses</span> <span class="kn">import</span> <span class="n">PlainTextResponse</span>
<span class="n">model_lock</span> <span class="o">=</span> <span class="nc">Lock</span><span class="p">()</span>

<span class="n">sources</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">tomh</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tomh/toxigen_hatebert</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">gronlp</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">GroNLP/hateBERT</span><span class="sh">"</span>
<span class="p">}</span>

<span class="n">languages</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">tomh</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">en</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">gronlp</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">en</span><span class="sh">"</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">Settings</span><span class="p">(</span><span class="n">BaseSettings</span><span class="p">):</span>
    <span class="c1"># Name of this annotator
</span>    <span class="n">annotator_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1"># Version of this annotator
</span>    <span class="n">annotator_version</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1"># Log level
</span>    <span class="n">log_level</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1"># model_name
</span>    <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1"># Name of this annotator
</span>    <span class="n">model_version</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1">#cach_size
</span>    <span class="n">model_cache_size</span><span class="p">:</span> <span class="nb">int</span>
    <span class="c1"># url of the model
</span>    <span class="n">model_source</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1"># language of the model
</span>    <span class="n">model_lang</span><span class="p">:</span> <span class="nb">str</span>


<span class="c1"># Load settings from env vars
</span><span class="n">settings</span> <span class="o">=</span> <span class="nc">Settings</span><span class="p">()</span>
<span class="n">lru_cache_with_size</span> <span class="o">=</span> <span class="nf">lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">model_cache_size</span><span class="p">)</span>
<span class="c1"># Set up logging with the specified log level
</span><span class="n">logging</span><span class="p">.</span><span class="nf">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">log_level</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="nf">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="c1"># Set the device to GPU if available, otherwise to CPU
</span><span class="n">device</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="nf">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="sh">"</span><span class="s">cpu</span><span class="sh">"</span>
<span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">USING </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># Load the predefined typesystem that is needed for this annotator to work
</span><span class="n">typesystem_filename</span> <span class="o">=</span> <span class="sh">'</span><span class="s">TypeSystemHate.xml</span><span class="sh">'</span>
<span class="n">logger</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sh">"</span><span class="s">Loading typesystem from </span><span class="se">\"</span><span class="s">%s</span><span class="se">\"</span><span class="sh">"</span><span class="p">,</span> <span class="n">typesystem_filename</span><span class="p">)</span>
<span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">typesystem_filename</span><span class="p">,</span> <span class="sh">'</span><span class="s">rb</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">typesystem</span> <span class="o">=</span> <span class="nf">load_typesystem</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sh">"</span><span class="s">Base typesystem:</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="n">typesystem</span><span class="p">.</span><span class="nf">to_xml</span><span class="p">())</span>

<span class="c1"># Load the Lua communication script
</span><span class="n">lua_communication_script_filename</span> <span class="o">=</span> <span class="sh">"</span><span class="s">duui_hate.lua</span><span class="sh">"</span>
<span class="n">logger</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sh">"</span><span class="s">Loading Lua communication script from </span><span class="se">\"</span><span class="s">%s</span><span class="se">\"</span><span class="sh">"</span><span class="p">,</span> <span class="n">lua_communication_script_filename</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">UimaSentence</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">text</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">begin</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">end</span><span class="p">:</span> <span class="nb">int</span>


<span class="k">class</span> <span class="nc">UimaSentenceSelection</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">selection</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">sentences</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">UimaSentence</span><span class="p">]</span>

<span class="c1"># Request sent by DUUI
# Note, this is transformed by the Lua script
</span><span class="k">class</span> <span class="nc">DUUIRequest</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="c1"># Length of the document
</span>    <span class="n">doc_len</span><span class="p">:</span> <span class="nb">int</span>
    <span class="c1"># Language of the document
</span>    <span class="n">lang</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1"># List of input of the selected type
</span>    <span class="n">selections</span><span class="p">:</span>  <span class="n">List</span><span class="p">[</span><span class="n">UimaSentenceSelection</span><span class="p">]</span>


<span class="c1"># UIMA type: mark modification of the document 
# This is used to store the modification meta information in the CAS, for example who annotated the document, when and with which tool
</span><span class="k">class</span> <span class="nc">DocumentModification</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">user</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">comment</span><span class="p">:</span> <span class="nb">str</span>

<span class="c1"># UIMA type: adds metadata to each annotation
# This is used to store the meta information in the CAS, for example which tool was used for the annotation and which version of the tool was used.
# It is important for the reproducibility of the analysis.
</span><span class="k">class</span> <span class="nc">AnnotationMeta</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">version</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">modelName</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">modelVersion</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">def</span> <span class="nf">fix_unicode_problems</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="c1"># fix emoji in python string and prevent json error on response
</span>    <span class="c1"># File "/usr/local/lib/python3.8/site-packages/starlette/responses.py", line 190, in render
</span>    <span class="c1"># UnicodeEncodeError: 'utf-8' codec can't encode characters in position xx-yy: surrogates not allowed
</span>    <span class="n">clean_text</span> <span class="o">=</span> <span class="n">text</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-16</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">surrogatepass</span><span class="sh">'</span><span class="p">).</span><span class="nf">decode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-16</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">surrogateescape</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">clean_text</span>

<span class="c1"># Process function for HateCheck
</span><span class="k">def</span> <span class="nf">process_selection</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">selection</span><span class="p">):</span>
    <span class="n">begin</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">end</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">non_hate</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">hate</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Fix unicode problems
</span>    <span class="c1"># Extract the text from the sentences
</span>    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">.</span><span class="n">sentences</span><span class="p">:</span>
        <span class="n">s</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="nf">fix_unicode_problems</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>

    <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">s</span><span class="p">.</span><span class="n">text</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">.</span><span class="n">sentences</span>
    <span class="p">]</span>
    <span class="k">with</span> <span class="n">model_lock</span><span class="p">:</span>
        <span class="n">classifier</span> <span class="o">=</span> <span class="nf">load_model</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
        <span class="c1"># Get the results from the HateCheck tool
</span>        <span class="n">results</span> <span class="o">=</span> <span class="n">classifier</span><span class="p">.</span><span class="nf">hate_prediction</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">res</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
            <span class="n">sentence</span> <span class="o">=</span> <span class="n">selection</span><span class="p">.</span><span class="n">sentences</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
                <span class="c1"># Add the results to the respective lists
</span>                <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="sh">"</span><span class="s">label</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">NOT HATE</span><span class="sh">"</span><span class="p">:</span>
                    <span class="n">non_hate</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="sh">"</span><span class="s">score</span><span class="sh">"</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">hate</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="sh">"</span><span class="s">score</span><span class="sh">"</span><span class="p">])</span>
            <span class="n">begin</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">sentence</span><span class="p">.</span><span class="n">begin</span><span class="p">)</span>
            <span class="n">end</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">sentence</span><span class="p">.</span><span class="n">end</span><span class="p">)</span>
    <span class="c1"># Return the results
</span>    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">begin</span><span class="sh">"</span><span class="p">:</span> <span class="n">begin</span><span class="p">,</span> <span class="sh">"</span><span class="s">end</span><span class="sh">"</span><span class="p">:</span> <span class="n">end</span><span class="p">,</span> <span class="sh">"</span><span class="s">non_hate</span><span class="sh">"</span><span class="p">:</span> <span class="n">non_hate</span><span class="p">,</span> <span class="sh">"</span><span class="s">hate</span><span class="sh">"</span><span class="p">:</span> <span class="n">hate</span><span class="p">}</span>



<span class="c1"># Response sent by DUUI
# Note, this is transformed by the Lua script
# Output of the HateCheck tool
</span><span class="k">class</span> <span class="nc">DUUIResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="c1"># Meta information, one per document
</span>    <span class="n">meta</span><span class="p">:</span> <span class="n">AnnotationMeta</span>
    <span class="c1"># Modification meta, one per document
</span>    <span class="n">modification_meta</span><span class="p">:</span> <span class="n">DocumentModification</span>
    <span class="c1"># Begin position of the annotations
</span>    <span class="n">begins</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="c1"># End position of the annotations
</span>    <span class="n">ends</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="c1"># Probability of non hate
</span>    <span class="n">non_hate</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
    <span class="c1"># Probability of hate
</span>    <span class="n">hate</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
    <span class="c1"># Model information
</span>    <span class="c1"># Needed for the reproducibility of the analysis that every annotation has the information which tool was used for the annotation.
</span>    <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1"># Version of the model used for the annotation
</span>    <span class="n">model_version</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1"># Source of the model used for the annotation
</span>    <span class="n">model_source</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1"># Language of the model used for the annotation
</span>    <span class="n">model_lang</span><span class="p">:</span> <span class="nb">str</span>


<span class="c1"># REST API definition with FastAPI
</span><span class="n">app</span> <span class="o">=</span> <span class="nc">FastAPI</span><span class="p">(</span>
    <span class="n">openapi_url</span><span class="o">=</span><span class="sh">"</span><span class="s">/openapi.json</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">docs_url</span><span class="o">=</span><span class="sh">"</span><span class="s">/api</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">redoc_url</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">annotator_name</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Hate annotator</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">version</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">model_version</span><span class="p">,</span>
    <span class="n">terms_of_service</span><span class="o">=</span><span class="sh">"</span><span class="s">https://www.texttechnologylab.org/legal_notice/</span><span class="sh">"</span><span class="p">,</span>
    <span class="c1"># Contact of creator
</span>    <span class="n">contact</span><span class="o">=</span><span class="p">{</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">TTLab Team</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">https://texttechnologylab.org</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">email</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">bagci@em.uni-frankfurt.de</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">license_info</span><span class="o">=</span><span class="p">{</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">AGPL</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">http://www.gnu.org/licenses/agpl-3.0.en.html</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span>

<span class="c1"># Reading Lua communication script
</span><span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">lua_communication_script_filename</span><span class="p">,</span> <span class="sh">'</span><span class="s">rb</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">lua_communication_script</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>
<span class="n">logger</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sh">"</span><span class="s">Lua communication script:</span><span class="sh">"</span><span class="p">)</span>
<span class="n">logger</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="n">lua_communication_script_filename</span><span class="p">)</span>


<span class="c1"># Get typesystem of this annotator
</span><span class="nd">@app.get</span><span class="p">(</span><span class="sh">"</span><span class="s">/v1/typesystem</span><span class="sh">"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_typesystem</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="c1"># TODO remove cassis dependency, as only needed for typesystem at the moment?
</span>    <span class="n">xml</span> <span class="o">=</span> <span class="n">typesystem</span><span class="p">.</span><span class="nf">to_xml</span><span class="p">()</span>
    <span class="n">xml_content</span> <span class="o">=</span> <span class="n">xml</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">return</span> <span class="nc">Response</span><span class="p">(</span>
        <span class="n">content</span><span class="o">=</span><span class="n">xml_content</span><span class="p">,</span>
        <span class="n">media_type</span><span class="o">=</span><span class="sh">"</span><span class="s">application/xml</span><span class="sh">"</span>
    <span class="p">)</span>


<span class="c1"># Return Lua communication script
</span><span class="nd">@app.get</span><span class="p">(</span><span class="sh">"</span><span class="s">/v1/communication_layer</span><span class="sh">"</span><span class="p">,</span> <span class="n">response_class</span><span class="o">=</span><span class="n">PlainTextResponse</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_communication_layer</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">lua_communication_script</span>


<span class="c1"># Return documentation info
</span><span class="nd">@app.get</span><span class="p">(</span><span class="sh">"</span><span class="s">/v1/documentation</span><span class="sh">"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_documentation</span><span class="p">():</span>
    <span class="k">return</span> <span class="sh">"</span><span class="s">Test</span><span class="sh">"</span>


<span class="c1"># Process request from DUUI
</span><span class="nd">@app.post</span><span class="p">(</span><span class="sh">"</span><span class="s">/v1/process</span><span class="sh">"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">post_process</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">DUUIRequest</span><span class="p">):</span>
    <span class="c1"># Return data
</span>    <span class="c1"># Save modification start time for later
</span>    <span class="n">modification_timestamp_seconds</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="nf">time</span><span class="p">())</span>
    <span class="c1"># Initialize lists for the output
</span>    <span class="c1"># Begin position of the annotations
</span>    <span class="n">begins</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># End position of the annotations
</span>    <span class="n">ends</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Probability of non hate
</span>    <span class="n">non_hate</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Probability of hate
</span>    <span class="n">hate</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Get the model information from the settings
</span>        <span class="n">model_source</span> <span class="o">=</span> <span class="n">settings</span><span class="p">.</span><span class="n">model_source</span>
        <span class="n">model_lang</span> <span class="o">=</span> <span class="n">settings</span><span class="p">.</span><span class="n">model_lang</span>
        <span class="c1"># set meta Informations
</span>        <span class="n">meta</span> <span class="o">=</span> <span class="nc">AnnotationMeta</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">annotator_name</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">annotator_version</span><span class="p">,</span>
            <span class="n">modelName</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">model_name</span><span class="p">,</span>
            <span class="n">modelVersion</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">model_version</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Add modification info
</span>        <span class="n">modification_meta_comment</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">settings</span><span class="p">.</span><span class="n">annotator_name</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">settings</span><span class="p">.</span><span class="n">annotator_version</span><span class="si">}</span><span class="s">))</span><span class="sh">"</span>
        <span class="n">modification_meta</span> <span class="o">=</span> <span class="nc">DocumentModification</span><span class="p">(</span>
            <span class="n">user</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">annotator_name</span><span class="p">,</span>
            <span class="n">timestamp</span><span class="o">=</span><span class="n">modification_timestamp_seconds</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="n">modification_meta_comment</span>
        <span class="p">)</span>
        <span class="c1"># Process the selections
</span>        <span class="k">for</span> <span class="n">selection</span> <span class="ow">in</span> <span class="n">request</span><span class="p">.</span><span class="n">selections</span><span class="p">:</span>
            <span class="c1"># get the output of the HateCheck tool
</span>            <span class="n">output</span> <span class="o">=</span> <span class="nf">process_selection</span><span class="p">(</span><span class="n">settings</span><span class="p">.</span><span class="n">model_name</span><span class="p">,</span> <span class="n">selection</span><span class="p">)</span>
            <span class="c1"># Add the output to the lists
</span>            <span class="n">begins</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="sh">"</span><span class="s">begin</span><span class="sh">"</span><span class="p">])</span>
            <span class="n">ends</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="sh">"</span><span class="s">end</span><span class="sh">"</span><span class="p">])</span>
            <span class="n">non_hate</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="sh">"</span><span class="s">non_hate</span><span class="sh">"</span><span class="p">])</span>
            <span class="n">hate</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="sh">"</span><span class="s">hate</span><span class="sh">"</span><span class="p">])</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">exception</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
    <span class="c1"># Return the response
</span>    <span class="k">return</span> <span class="nc">DUUIResponse</span><span class="p">(</span><span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">,</span> <span class="n">modification_meta</span><span class="o">=</span><span class="n">modification_meta</span><span class="p">,</span> <span class="n">begins</span><span class="o">=</span><span class="n">begins</span><span class="p">,</span> <span class="n">ends</span><span class="o">=</span><span class="n">ends</span><span class="p">,</span> <span class="n">non_hate</span><span class="o">=</span><span class="n">non_hate</span><span class="p">,</span> <span class="n">hate</span><span class="o">=</span><span class="n">hate</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">model_name</span><span class="p">,</span> <span class="n">model_version</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">model_version</span><span class="p">,</span> <span class="n">model_source</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">model_source</span><span class="p">,</span> <span class="n">model_lang</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">model_lang</span><span class="p">)</span>

<span class="nd">@lru_cache_with_size</span>
<span class="k">def</span> <span class="nf">load_model</span><span class="p">(</span><span class="n">model_name</span><span class="p">):</span>
    <span class="n">model_i</span> <span class="o">=</span> <span class="nc">HateCheck</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model_i</span>


</code></pre></div></div>

<h2 id="lua">Lua</h2>
<p>Here is an example of the LUA script, with some comments to explain the code for HateCheck LUA script:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Bind static classes from java to lua variables</span>
<span class="n">StandardCharsets</span> <span class="o">=</span> <span class="n">luajava</span><span class="p">.</span><span class="n">bindClass</span><span class="p">(</span><span class="s2">"java.nio.charset.StandardCharsets"</span><span class="p">)</span>
<span class="n">Class</span> <span class="o">=</span> <span class="n">luajava</span><span class="p">.</span><span class="n">bindClass</span><span class="p">(</span><span class="s2">"java.lang.Class"</span><span class="p">)</span>
<span class="n">JCasUtil</span> <span class="o">=</span> <span class="n">luajava</span><span class="p">.</span><span class="n">bindClass</span><span class="p">(</span><span class="s2">"org.apache.uima.fit.util.JCasUtil"</span><span class="p">)</span>
<span class="c1">-- Bind the classes from the typesystem to lua variables</span>
<span class="n">HateCheck</span> <span class="o">=</span> <span class="n">luajava</span><span class="p">.</span><span class="n">bindClass</span><span class="p">(</span><span class="s2">"org.texttechnologylab.annotation.Hate"</span><span class="p">)</span>

<span class="k">function</span> <span class="nf">serialize</span><span class="p">(</span><span class="n">inputCas</span><span class="p">,</span> <span class="n">outputStream</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>
   <span class="c1">-- Get the document language, text and length from the CAS object</span>
    <span class="kd">local</span> <span class="n">doc_lang</span> <span class="o">=</span> <span class="n">inputCas</span><span class="p">:</span><span class="n">getDocumentLanguage</span><span class="p">()</span>
    <span class="kd">local</span> <span class="n">doc_text</span> <span class="o">=</span> <span class="n">inputCas</span><span class="p">:</span><span class="n">getDocumentText</span><span class="p">()</span>
    <span class="kd">local</span> <span class="n">doc_len</span> <span class="o">=</span> <span class="n">TopicUtils</span><span class="p">:</span><span class="n">getDocumentTextLength</span><span class="p">(</span><span class="n">inputCas</span><span class="p">)</span>
    <span class="c1">-- Get the selection types from the input parameters</span>
    <span class="c1">-- The selection types are the types of annotations that the user wants to send to the annotator</span>
    <span class="c1">-- The parameter is a comma-separated list of different inputs</span>
    <span class="kd">local</span> <span class="n">selection_types</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">"selection"</span><span class="p">]</span>
    <span class="kd">local</span> <span class="n">selections</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="kd">local</span> <span class="n">selections_count</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1">-- Iterate over the selection types</span>
    <span class="k">for</span> <span class="n">selection_type</span> <span class="k">in</span> <span class="nb">string.gmatch</span><span class="p">(</span><span class="n">selection_types</span><span class="p">,</span> <span class="s2">"([^,]+)"</span><span class="p">)</span> <span class="k">do</span>
       <span class="kd">local</span> <span class="n">sentences</span> <span class="o">=</span> <span class="p">{}</span>
       <span class="c1">-- If the selection type is text, create a selection with the whole document text</span>
       <span class="k">if</span> <span class="n">selection_type</span> <span class="o">==</span> <span class="s2">"text"</span> <span class="k">then</span>
           <span class="kd">local</span> <span class="n">s</span> <span class="o">=</span> <span class="p">{</span>
               <span class="n">text</span> <span class="o">=</span> <span class="n">doc_text</span><span class="p">,</span>
               <span class="n">begin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
               <span class="p">[</span><span class="s1">'end'</span><span class="p">]</span> <span class="o">=</span> <span class="n">doc_len</span>
           <span class="p">}</span>
           <span class="n">sentences</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
       <span class="k">else</span>
           <span class="c1">-- If the selection type is a specific annotation type, get the covered text of the annotation and its begin and end offsets</span>
           <span class="kd">local</span> <span class="n">sentences_count</span> <span class="o">=</span> <span class="mi">1</span>
           <span class="kd">local</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">Class</span><span class="p">:</span><span class="n">forName</span><span class="p">(</span><span class="n">selection_type</span><span class="p">);</span>
           <span class="kd">local</span> <span class="n">sentences_it</span> <span class="o">=</span> <span class="n">JCasUtil</span><span class="p">:</span><span class="nb">select</span><span class="p">(</span><span class="n">inputCas</span><span class="p">,</span> <span class="n">clazz</span><span class="p">):</span><span class="n">iterator</span><span class="p">()</span>
           <span class="k">while</span> <span class="n">sentences_it</span><span class="p">:</span><span class="n">hasNext</span><span class="p">()</span> <span class="k">do</span>
               <span class="kd">local</span> <span class="n">sentence</span> <span class="o">=</span> <span class="n">sentences_it</span><span class="p">:</span><span class="nb">next</span><span class="p">()</span>
               <span class="kd">local</span> <span class="n">s</span> <span class="o">=</span> <span class="p">{</span>
                   <span class="n">text</span> <span class="o">=</span> <span class="n">sentence</span><span class="p">:</span><span class="n">getCoveredText</span><span class="p">(),</span>
                   <span class="n">begin</span> <span class="o">=</span> <span class="n">sentence</span><span class="p">:</span><span class="n">getBegin</span><span class="p">(),</span>
                   <span class="p">[</span><span class="s1">'end'</span><span class="p">]</span> <span class="o">=</span> <span class="n">sentence</span><span class="p">:</span><span class="n">getEnd</span><span class="p">()</span>
               <span class="p">}</span>
               <span class="nb">print</span><span class="p">(</span><span class="n">sentence</span><span class="p">:</span><span class="n">getCoveredText</span><span class="p">())</span>
               <span class="n">sentences</span><span class="p">[</span><span class="n">sentences_count</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
               <span class="n">sentences_count</span> <span class="o">=</span> <span class="n">sentences_count</span> <span class="o">+</span> <span class="mi">1</span>
           <span class="k">end</span>
       <span class="k">end</span>
       <span class="kd">local</span> <span class="n">selection</span> <span class="o">=</span> <span class="p">{</span>
           <span class="n">sentences</span> <span class="o">=</span> <span class="n">sentences</span><span class="p">,</span>
           <span class="n">selection</span> <span class="o">=</span> <span class="n">selection_type</span>
       <span class="p">}</span>
       <span class="n">selections</span><span class="p">[</span><span class="n">selections_count</span><span class="p">]</span> <span class="o">=</span> <span class="n">selection</span>
       <span class="n">selections_count</span> <span class="o">=</span> <span class="n">selections_count</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">end</span>
    <span class="c1">-- the Inputs for the python process, note that names must be the same as in the main python script </span>
    <span class="n">outputStream</span><span class="p">:</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="n">encode</span><span class="p">({</span>
        <span class="n">selections</span> <span class="o">=</span> <span class="n">selections</span><span class="p">,</span>
        <span class="n">lang</span> <span class="o">=</span> <span class="n">doc_lang</span><span class="p">,</span>
        <span class="n">doc_len</span> <span class="o">=</span> <span class="n">doc_len</span>
    <span class="p">}))</span>
<span class="k">end</span>

<span class="c1">-- This "deserialize" function is called on receiving the results from the annotator that have to be transformed into a CAS object</span>
<span class="c1">-- Inputs:</span>
<span class="c1">--  - inputCas: The actual CAS object to deserialize into</span>
<span class="c1">--  - inputStream: Stream that is received from to the annotator, can be e.g. a string, JSON payload, ...</span>
<span class="k">function</span> <span class="nf">deserialize</span><span class="p">(</span><span class="n">inputCas</span><span class="p">,</span> <span class="n">inputStream</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">inputString</span> <span class="o">=</span> <span class="n">luajava</span><span class="p">.</span><span class="n">newInstance</span><span class="p">(</span><span class="s2">"java.lang.String"</span><span class="p">,</span> <span class="n">inputStream</span><span class="p">:</span><span class="n">readAllBytes</span><span class="p">(),</span> <span class="n">StandardCharsets</span><span class="p">.</span><span class="n">UTF_8</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">results</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">inputString</span><span class="p">)</span>
    
    <span class="c1">-- Check if the results contain the necessary information</span>
    <span class="k">if</span> <span class="n">results</span><span class="p">[</span><span class="s2">"modification_meta"</span><span class="p">]</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="ow">and</span> <span class="n">results</span><span class="p">[</span><span class="s2">"meta"</span><span class="p">]</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="ow">and</span> <span class="n">results</span><span class="p">[</span><span class="s2">"begins"</span><span class="p">]</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="k">then</span>
        
        <span class="c1">-- Get the model information from the results</span>
        <span class="kd">local</span> <span class="n">source</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">"model_source"</span><span class="p">]</span>
        <span class="kd">local</span> <span class="n">model_version</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">"model_version"</span><span class="p">]</span>
        <span class="kd">local</span> <span class="n">model_name</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">"model_name"</span><span class="p">]</span>
        <span class="kd">local</span> <span class="n">model_lang</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">"model_lang"</span><span class="p">]</span>
        <span class="kd">local</span> <span class="n">modification_meta</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">"modification_meta"</span><span class="p">]</span>
        
        <span class="c1">-- Create a new DocumentModification annotation and add it to the CAS</span>
        <span class="kd">local</span> <span class="n">modification_anno</span> <span class="o">=</span> <span class="n">luajava</span><span class="p">.</span><span class="n">newInstance</span><span class="p">(</span><span class="s2">"org.texttechnologylab.annotation.DocumentModification"</span><span class="p">,</span> <span class="n">inputCas</span><span class="p">)</span>
        <span class="n">modification_anno</span><span class="p">:</span><span class="n">setUser</span><span class="p">(</span><span class="n">modification_meta</span><span class="p">[</span><span class="s2">"user"</span><span class="p">])</span>
        <span class="n">modification_anno</span><span class="p">:</span><span class="n">setTimestamp</span><span class="p">(</span><span class="n">modification_meta</span><span class="p">[</span><span class="s2">"timestamp"</span><span class="p">])</span>
        <span class="n">modification_anno</span><span class="p">:</span><span class="n">setComment</span><span class="p">(</span><span class="n">modification_meta</span><span class="p">[</span><span class="s2">"comment"</span><span class="p">])</span>
        <span class="n">modification_anno</span><span class="p">:</span><span class="n">addToIndexes</span><span class="p">()</span>
        
        <span class="c1">-- Create a new MetaData annotation and add it to the CAS</span>
        <span class="kd">local</span> <span class="n">model_meta</span> <span class="o">=</span> <span class="n">luajava</span><span class="p">.</span><span class="n">newInstance</span><span class="p">(</span><span class="s2">"org.texttechnologylab.annotation.model.MetaData"</span><span class="p">,</span> <span class="n">inputCas</span><span class="p">)</span>
        <span class="n">model_meta</span><span class="p">:</span><span class="n">setModelVersion</span><span class="p">(</span><span class="n">model_version</span><span class="p">)</span>
        <span class="n">model_meta</span><span class="p">:</span><span class="n">setModelName</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
        <span class="n">model_meta</span><span class="p">:</span><span class="n">setSource</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="n">model_meta</span><span class="p">:</span><span class="n">setLang</span><span class="p">(</span><span class="n">model_lang</span><span class="p">)</span>
        <span class="n">model_meta</span><span class="p">:</span><span class="n">addToIndexes</span><span class="p">()</span>
        
        <span class="c1">-- Get the results from the annotator</span>
        <span class="kd">local</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">"meta"</span><span class="p">]</span>
        <span class="kd">local</span> <span class="n">begins</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">"begins"</span><span class="p">]</span>
        <span class="kd">local</span> <span class="n">ends</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">"ends"</span><span class="p">]</span>
        <span class="kd">local</span> <span class="n">hates</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">"hate"</span><span class="p">]</span>
        <span class="kd">local</span> <span class="n">non_hates</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">"non_hate"</span><span class="p">]</span>
        
        <span class="c1">-- Iterate over the results and create new Hate annotations for each result</span>
        <span class="k">for</span> <span class="n">index_i</span><span class="p">,</span> <span class="n">res</span> <span class="k">in</span> <span class="nb">ipairs</span><span class="p">(</span><span class="n">hates</span><span class="p">)</span> <span class="k">do</span>
            <span class="kd">local</span> <span class="n">hate</span> <span class="o">=</span> <span class="n">luajava</span><span class="p">.</span><span class="n">newInstance</span><span class="p">(</span><span class="s2">"org.texttechnologylab.annotation.Hate"</span><span class="p">,</span> <span class="n">inputCas</span><span class="p">)</span>
            <span class="n">hate</span><span class="p">:</span><span class="n">setBegin</span><span class="p">(</span><span class="n">begins</span><span class="p">[</span><span class="n">index_i</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">begins</span><span class="p">[</span><span class="n">index_i</span><span class="p">])</span>
            <span class="n">hate</span><span class="p">:</span><span class="n">setEnd</span><span class="p">(</span><span class="n">ends</span><span class="p">[</span><span class="n">index_i</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">ends</span><span class="p">[</span><span class="n">index_i</span><span class="p">])</span>
            <span class="n">hate</span><span class="p">:</span><span class="n">setHate</span><span class="p">(</span><span class="n">hates</span><span class="p">[</span><span class="n">index_i</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">hates</span><span class="p">[</span><span class="n">index_i</span><span class="p">])</span>
            <span class="n">hate</span><span class="p">:</span><span class="n">setNonHate</span><span class="p">(</span><span class="n">non_hates</span><span class="p">[</span><span class="n">index_i</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">non_hates</span><span class="p">[</span><span class="n">index_i</span><span class="p">])</span>
            <span class="n">hate</span><span class="p">:</span><span class="n">setModel</span><span class="p">(</span><span class="n">model_meta</span><span class="p">)</span>
            <span class="n">hate</span><span class="p">:</span><span class="n">addToIndexes</span><span class="p">()</span>
        <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>
<h2 id="docker-container">Docker Container</h2>
<p>The Docker container is defined in the Dockerfile, here is an example for building a Docker container for HateCheck:</p>
<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># HateCheck is implemented in Python for this reason we use the Python with necessary version</span>
<span class="k">FROM</span><span class="s"> python:3.8</span>

<span class="c"># Define the working directory</span>
<span class="k">WORKDIR</span><span class="s"> /usr/src/app</span>

<span class="c"># Expose the port of DUUI, which is 9714</span>
<span class="c"># Note that the port 9714 must be expose by every build Docker container</span>
<span class="k">EXPOSE</span><span class="s"> 9714</span>

<span class="c"># Copy the requirements file to the working directory</span>
<span class="k">COPY</span><span class="s"> ./reqiurements.txt ./reqiurements.txt</span>
<span class="c"># Install the necessary packages</span>
<span class="k">RUN </span>pip <span class="nb">install </span><span class="nv">torch</span><span class="o">==</span>2.2.0 <span class="nv">torchvision</span><span class="o">==</span>0.17.0 <span class="nv">torchaudio</span><span class="o">==</span>2.2.0 <span class="nt">--index-url</span> https://download.pytorch.org/whl/cu118
<span class="k">RUN </span>pip <span class="nb">install</span> <span class="nt">-r</span> reqiurements.txt

<span class="c"># Download the necessary models to save time when the Docker container is started</span>
<span class="k">RUN </span>python <span class="nt">-c</span> <span class="s2">"from transformers import pipeline; pipeline('text-classification', model='Andrazp/multilingual-hate-speech-robacofi')"</span>

<span class="c"># Copy the necessary files to the working directory</span>
<span class="c"># It is possible to python directory to the working directory</span>
<span class="c"># For the demonstration we copy every file to the working directory separately</span>
<span class="c"># TypeSystemHate.xml is the typesystem for the HateCheck tool</span>
<span class="k">COPY</span><span class="s"> ./src/main/python/TypeSystemHate.xml ./TypeSystemHate.xml</span>
<span class="c"># Evaluation.py is the evaluation script for the HateCheck tool</span>
<span class="k">COPY</span><span class="s"> ./src/main/python/evaluator.py ./evaluator.py</span>
<span class="c"># HateCheck.py define seperatly the HateCheck tool</span>
<span class="k">COPY</span><span class="s"> ./src/main/python/hatechecker.py ./hatechecker.py</span>
<span class="c"># HateCheck.lua is the LUA script for the communication between the UIMA pipeline and the HateCheck tool</span>
<span class="k">COPY</span><span class="s"> ./src/main/python/duui_hate.lua ./duui_hate.lua</span>
<span class="c"># HateCheck.py is the main python script for the HateCheck tool</span>
<span class="k">COPY</span><span class="s"> ./src/main/python/duui_hate.py ./duui_hate.py</span>


<span class="c"># Define the necessary environment variables</span>
<span class="c"># ARG is used to define the default environment variables</span>
<span class="k">ARG</span><span class="s"> ANNOTATOR_NAME="duui-hate:app"</span>
<span class="c"># ENV is used to define the environment variables, will be overwritten by the docker-compose file, if the environment variables are defined in the build process</span>
<span class="k">ENV</span><span class="s"> ANNOTATOR_NAME=$ANNOTATOR_NAME</span>
<span class="k">ARG</span><span class="s"> ANNOTATOR_VERSION="unset"</span>
<span class="k">ENV</span><span class="s"> ANNOTATOR_VERSION=$ANNOTATOR_VERSION</span>

<span class="c"># log level</span>
<span class="k">ARG</span><span class="s"> LOG_LEVEL="DEBUG"</span>
<span class="k">ENV</span><span class="s"> LOG_LEVEL=$LOG_LEVEL</span>

<span class="c"># config</span>
<span class="k">ARG</span><span class="s"> MODEL_CACHE_SIZE=1</span>
<span class="k">ENV</span><span class="s"> MODEL_CACHE_SIZE=$MODEL_CACHE_SIZE</span>
<span class="k">ARG</span><span class="s"> MODEL_NAME=""</span>
<span class="k">ENV</span><span class="s"> MODEL_NAME=$MODEL_NAME</span>
<span class="k">ARG</span><span class="s"> MODEL_VERSION=""</span>
<span class="k">ENV</span><span class="s"> MODEL_VERSION=$MODEL_VERSION</span>
<span class="k">ARG</span><span class="s"> MODEL_SOURCE=""</span>
<span class="k">ENV</span><span class="s"> MODEL_SOURCE=$MODEL_SOURCE</span>
<span class="k">ARG</span><span class="s"> MODEL_LANG=""</span>
<span class="k">ENV</span><span class="s"> MODEL_LANG=$MODEL_LANG</span>

<span class="c"># Define the entrypoint for the Docker container, the entrypoint is the main script that is executed when the Docker container is started, where POST Process is called</span>
<span class="c"># The name of the main script must written before :app</span>
<span class="c"># The Entyproint used the uvicorn server to start the main script.</span>
<span class="c"># The host is defined as 0.0.0.0 to ensure that the Docker container is accessible from the outside</span>
<span class="c"># The port is defined as 9714, which is port to the outside</span>
<span class="k">ENTRYPOINT</span><span class="s"> ["uvicorn", "duui_hate:app", "--host", "0.0.0.0", "--port" ,"9714"]</span>
<span class="c"># Define the number of workers</span>
<span class="k">CMD</span><span class="s"> ["--workers", "1"]</span>
</code></pre></div></div>

<h2 id="docker-bash-script">Docker Bash Script</h2>
<p>The Docker Bash Script is used to build the Docker container and save the Docker container with right name and version.
Here is an example of the Docker Bash Script for HateCheck:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Define the necessary environment variables</span>
<span class="nb">export </span><span class="nv">ANNOTATOR_NAME</span><span class="o">=</span>duui-hate
<span class="nb">export </span><span class="nv">ANNOTATOR_VERSION</span><span class="o">=</span>0.1.0
<span class="nb">export </span><span class="nv">LOG_LEVEL</span><span class="o">=</span>INFO
eport <span class="nv">MODEL_CACHE_SIZE</span><span class="o">=</span>3

<span class="c">#---------------------------------------------------------------------</span>
<span class="c"># Define the necessary environment variables for the HateCheck tool</span>
<span class="nb">export  </span><span class="nv">MODEL_NAME</span><span class="o">=</span><span class="s2">"Andrazp/multilingual-hate-speech-robacofi"</span>
<span class="nb">export </span><span class="nv">MODEL_SPECNAME</span><span class="o">=</span><span class="s2">"andrazp"</span>
<span class="nb">export </span><span class="nv">MODEL_VERSION</span><span class="o">=</span><span class="s2">"c2b98c47f5e13c326a7af48ba544fff4d93fbc70"</span>
<span class="nb">export </span><span class="nv">MODEL_SOURCE</span><span class="o">=</span><span class="s2">"https://huggingface.co/Andrazp/multilingual-hate-speech-robacofi"</span>
<span class="nb">export </span><span class="nv">MODEL_LANG</span><span class="o">=</span><span class="s2">"Multi"</span>
<span class="c">#--------------------------------------------------------------------</span>

<span class="c"># Define the Docker Registry, the Docker Registry is used to save the Docker container with the right name and version</span>
<span class="c"># The name docker.texttechnologylab.org is the Docker Registry of the Texttechnology Lab at the Goethe University Frankfurt</span>
<span class="nb">export </span><span class="nv">DOCKER_REGISTRY</span><span class="o">=</span><span class="s2">"docker.texttechnologylab.org/"</span>
<span class="nb">export </span><span class="nv">DUUI_CUDA</span><span class="o">=</span>
<span class="c"># If the tool is implemented with CUDA, then the name of the Docker container should be extended with -cuda, so that users can see that the tool is implemented with CUDA</span>
<span class="c">#export DUUI_CUDA="-cuda"</span>

<span class="c"># Build the Docker container with the necessary environment variables</span>
<span class="c"># --build-arg is necessary to define the environment variables in the Docker container</span>
docker build <span class="se">\</span>
  <span class="nt">--build-arg</span> ANNOTATOR_NAME <span class="se">\</span>
  <span class="nt">--build-arg</span> ANNOTATOR_VERSION <span class="se">\</span>
  <span class="nt">--build-arg</span> LOG_LEVEL <span class="se">\</span>
  <span class="nt">--build-arg</span> MODEL_CACHE_SIZE <span class="se">\</span>
  <span class="nt">--build-arg</span> MODEL_NAME <span class="se">\</span>
  <span class="nt">--build-arg</span> MODEL_VERSION <span class="se">\</span>
  <span class="nt">--build-arg</span> MODEL_SOURCE <span class="se">\</span>
  <span class="nt">--build-arg</span> MODEL_LANG <span class="se">\</span>
  <span class="c"># -t is used to define the name and version of the Docker container</span>
  <span class="nt">-t</span> <span class="k">${</span><span class="nv">DOCKER_REGISTRY</span><span class="k">}${</span><span class="nv">ANNOTATOR_NAME</span><span class="k">}</span><span class="s2">"-"</span><span class="k">${</span><span class="nv">MODEL_SPECNAME</span><span class="k">}</span>:<span class="k">${</span><span class="nv">ANNOTATOR_VERSION</span><span class="k">}${</span><span class="nv">DUUI_CUDA</span><span class="k">}</span> <span class="se">\</span>
  <span class="nt">-f</span> src/main/docker/Dockerfile<span class="k">${</span><span class="nv">DUUI_CUDA</span><span class="k">}</span> <span class="se">\</span>
  <span class="nb">.</span>

<span class="c"># Save the Docker container with the right name and version</span>
docker tag <span class="se">\</span>
  <span class="k">${</span><span class="nv">DOCKER_REGISTRY</span><span class="k">}${</span><span class="nv">ANNOTATOR_NAME</span><span class="k">}</span><span class="s2">"-"</span><span class="k">${</span><span class="nv">MODEL_SPECNAME</span><span class="k">}</span>:<span class="k">${</span><span class="nv">ANNOTATOR_VERSION</span><span class="k">}${</span><span class="nv">DUUI_CUDA</span><span class="k">}</span> <span class="se">\</span>
  <span class="k">${</span><span class="nv">DOCKER_REGISTRY</span><span class="k">}${</span><span class="nv">ANNOTATOR_NAME</span><span class="k">}</span><span class="s2">"-"</span><span class="k">${</span><span class="nv">MODEL_SPECNAME</span><span class="k">}</span>:latest<span class="k">${</span><span class="nv">DUUI_CUDA</span><span class="k">}</span>
</code></pre></div></div>

<h2 id="testing">Testing</h2>
<p>The testing of the integrated tool is important to ensure that the tool is working correctly.
It also helps to check how tool reacts to different inputs and outputs, so that the tool can be corrected if necessary, optimized or improved.
Junit test can be used to test the tool, here is an example of the Junit test for HateCheck:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// import the necessary packages</span>
<span class="kn">package</span> <span class="nn">org.hucompute.textimager.uima.hate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">de.tudarmstadt.ukp.dkpro.core.api.segmentation.type.Sentence</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.compress.compressors.CompressorException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.uima.UIMAException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.uima.fit.factory.JCasFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.uima.fit.util.JCasUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.uima.jcas.JCas</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.uima.util.XmlCasSerializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.texttechnologylab.DockerUnifiedUIMAInterface.DUUIComposer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.texttechnologylab.DockerUnifiedUIMAInterface.driver.DUUIRemoteDriver</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.texttechnologylab.DockerUnifiedUIMAInterface.lua.DUUILuaContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.xml.sax.SAXException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.ByteArrayOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.URISyntaxException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.UnknownHostException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.charset.StandardCharsets</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>

<span class="c1">// import the necessary types from the typesystem</span>
<span class="kn">import</span> <span class="nn">org.texttechnologylab.annotation.Hate</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MultiTestHate</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="nc">DUUIComposer</span> <span class="n">composer</span><span class="o">;</span>
    <span class="kd">static</span> <span class="nc">JCas</span> <span class="n">cas</span><span class="o">;</span>

    <span class="c1">// Define the URL of the Docker container</span>
    <span class="c1">// Docker container must be started locally</span>
    <span class="kd">static</span> <span class="nc">String</span> <span class="n">url</span> <span class="o">=</span> <span class="s">"http://127.0.0.1:9714"</span><span class="o">;</span>

    <span class="c1">// Define the composer and the cas object</span>
    <span class="nd">@BeforeAll</span>
    <span class="kd">static</span> <span class="kt">void</span> <span class="nf">beforeAll</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">URISyntaxException</span><span class="o">,</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">UIMAException</span><span class="o">,</span> <span class="nc">SAXException</span><span class="o">,</span> <span class="nc">CompressorException</span> <span class="o">{</span>
        <span class="n">composer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DUUIComposer</span><span class="o">()</span>
                <span class="o">.</span><span class="na">withSkipVerification</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
                <span class="o">.</span><span class="na">withLuaContext</span><span class="o">(</span><span class="k">new</span> <span class="nc">DUUILuaContext</span><span class="o">().</span><span class="na">withJsonLibrary</span><span class="o">());</span>

        <span class="nc">DUUIRemoteDriver</span> <span class="n">remoteDriver</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DUUIRemoteDriver</span><span class="o">();</span>
        <span class="n">composer</span><span class="o">.</span><span class="na">addDriver</span><span class="o">(</span><span class="n">remoteDriver</span><span class="o">);</span>
<span class="c1">//        DUUIDockerDriver docker_driver = new DUUIDockerDriver();</span>
<span class="c1">//        composer.addDriver(docker_driver);</span>


        <span class="n">cas</span> <span class="o">=</span> <span class="nc">JCasFactory</span><span class="o">.</span><span class="na">createJCas</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">// Shutdown the composer in the end</span>
    <span class="nd">@AfterAll</span>
    <span class="kd">static</span> <span class="kt">void</span> <span class="nf">afterAll</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">UnknownHostException</span> <span class="o">{</span>
        <span class="n">composer</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">// Reset the pipeline and the cas object after each test</span>
    <span class="nd">@AfterEach</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterEach</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">SAXException</span> <span class="o">{</span>
        <span class="n">composer</span><span class="o">.</span><span class="na">resetPipeline</span><span class="o">();</span>

        <span class="nc">ByteArrayOutputStream</span> <span class="n">stream</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ByteArrayOutputStream</span><span class="o">();</span>
        <span class="nc">XmlCasSerializer</span><span class="o">.</span><span class="na">serialize</span><span class="o">(</span><span class="n">cas</span><span class="o">.</span><span class="na">getCas</span><span class="o">(),</span> <span class="kc">null</span><span class="o">,</span> <span class="n">stream</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">stream</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="nc">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>

        <span class="n">cas</span><span class="o">.</span><span class="na">reset</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">// Function to integrate the list of sentences into the cas object, with beginning and end of the sentence</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">createCas</span><span class="o">(</span><span class="nc">String</span> <span class="n">language</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">sentences</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">UIMAException</span> <span class="o">{</span>
        <span class="n">cas</span><span class="o">.</span><span class="na">setDocumentLanguage</span><span class="o">(</span><span class="n">language</span><span class="o">);</span>

        <span class="nc">StringBuilder</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">sentence</span> <span class="o">:</span> <span class="n">sentences</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Sentence</span> <span class="n">sentenceAnnotation</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Sentence</span><span class="o">(</span><span class="n">cas</span><span class="o">,</span> <span class="n">sb</span><span class="o">.</span><span class="na">length</span><span class="o">(),</span> <span class="n">sb</span><span class="o">.</span><span class="na">length</span><span class="o">()+</span><span class="n">sentence</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
            <span class="n">sentenceAnnotation</span><span class="o">.</span><span class="na">addToIndexes</span><span class="o">();</span>
            <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">sentence</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">" "</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">cas</span><span class="o">.</span><span class="na">setDocumentText</span><span class="o">(</span><span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="c1">// Test the tools with english sentences</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">EnglishTest</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="c1">// Add the component to the composer with the necessary parameters</span>
        <span class="c1">// The selection parameter is used to define the type of annotations that the user wants to send to the annotator </span>
        <span class="c1">// In this case, the user wants to send the Sentence annotations to the annotator</span>
        <span class="n">composer</span><span class="o">.</span><span class="na">add</span><span class="o">(</span>
                <span class="k">new</span> <span class="nc">DUUIRemoteDriver</span><span class="o">.</span><span class="na">Component</span><span class="o">(</span><span class="n">url</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">withParameter</span><span class="o">(</span><span class="s">"selection"</span><span class="o">,</span> <span class="s">"de.tudarmstadt.ukp.dkpro.core.api.segmentation.type.Sentence"</span><span class="o">)</span>
        <span class="o">);</span>
        <span class="c1">// Define the sentences that are used for the test</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">sentences</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span>
                <span class="s">"I hate hate it. How can you do that bad thing to me! HOW!"</span><span class="o">,</span>
                <span class="s">"I very happy to be here. I love this place."</span>
        <span class="o">);</span>

        <span class="c1">// Create the CAS object with the necessary language and sentences</span>
        <span class="n">createCas</span><span class="o">(</span><span class="s">"en"</span><span class="o">,</span> <span class="n">sentences</span><span class="o">);</span>

        <span class="c1">// Run the composer with the CAS object</span>
        <span class="n">composer</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">cas</span><span class="o">);</span>

        <span class="c1">// Define the expected output</span>
        <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">expected</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">expected</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"0_57"</span><span class="o">,</span> <span class="s">"HATE"</span><span class="o">);</span>
        <span class="n">expected</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"58_101"</span><span class="o">,</span> <span class="s">"NonHate"</span><span class="o">);</span>
        
        <span class="c1">// Get all the Hate annotations from the CAS object and check if the output is the same as the expected output</span>
        <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">Hate</span><span class="o">&gt;</span> <span class="n">all_hate</span> <span class="o">=</span> <span class="nc">JCasUtil</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">cas</span><span class="o">,</span> <span class="nc">Hate</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Hate</span> <span class="n">hate</span> <span class="o">:</span> <span class="n">all_hate</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">begin</span> <span class="o">=</span> <span class="n">hate</span><span class="o">.</span><span class="na">getBegin</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">end</span> <span class="o">=</span> <span class="n">hate</span><span class="o">.</span><span class="na">getEnd</span><span class="o">();</span>
            <span class="kt">double</span> <span class="n">hate_i</span> <span class="o">=</span> <span class="n">hate</span><span class="o">.</span><span class="na">getHate</span><span class="o">();</span>
            <span class="kt">double</span> <span class="n">non_hate</span> <span class="o">=</span> <span class="n">hate</span><span class="o">.</span><span class="na">getNonHate</span><span class="o">();</span>
            <span class="nc">String</span> <span class="n">out_i</span> <span class="o">=</span> <span class="s">"HATE"</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">hate_i</span> <span class="o">&lt;</span> <span class="n">non_hate</span><span class="o">){</span>
                <span class="n">out_i</span> <span class="o">=</span> <span class="s">"NonHate"</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="nc">String</span> <span class="n">expected_i</span> <span class="o">=</span> <span class="n">expected</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">begin</span><span class="o">+</span><span class="s">"_"</span><span class="o">+</span><span class="n">end</span><span class="o">);</span>
            <span class="nc">Assertions</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">expected_i</span><span class="o">,</span> <span class="n">out_i</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

        </section>

        <aside id="sidebar">
          <img src="/assets/images/DUUI_Logo.png" width="100%">
          
          <a href="https://github.com/texttechnologylab/DockerUnifiedUIMAInterface" target="_blank" class="button"><small>View project on</small> GitHub</a>
          
          
          <a href="https://github.com/texttechnologylab" target="_blank" class="button"><small style="margin-top: -12px;">Powerd by</small>
          <img src="/assets/images/ttlab.png" width="80%;"></a>
<!--          <p class="repo-owner"><a href="https://github.com/texttechnologylab/DockerUnifiedUIMAInterface">Docker Unified UIMA Interface</a> is maintained by <a href="https://github.com/texttechnologylab">Texttechnology Lab</a>.</p>-->
          

          <p>This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</p>
        </aside>
      </div>
    </div>

  </body>
</html>
